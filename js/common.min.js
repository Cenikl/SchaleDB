$.holdReady(!0);const starscale_hp=[1,1.05,1.12,1.21,1.35],starscale_attack=[1,1.1,1.22,1.36,1.53],starscale_healing=[1,1.075,1.175,1.295,1.445],raid_level=[17,25,35,50,70,80],raid_reward_coin=[[40,0],[60,0],[80,0],[100,10],[120,20],[140,40]],languages=["En","Jp","Kr"],label_smalltext_threshold={En:11,Jp:5,Kr:5},label_enemy_smalltext_threshold={En:12,Jp:6,Kr:6},label_raid_smalltext_threshold={En:20,Jp:11,Kr:11},terrain_dmg_bonus={D:.8,C:.9,B:1,A:1.1,S:1.2,SS:1.3},terrain_block_bonus={D:0,C:15,B:30,A:45,S:60,SS:75},skill_ex_upgrade_credits=[8e4,5e5,3e6,1e7],skill_upgrade_credits=[5e3,7500,6e4,9e4,3e5,45e4,15e5,24e5,4e6],enemy_rank={Champion:1,Elite:2,Minion:3},max_gifts=35,module_list=["home","students","raids","stages","items","craft"],cache_ver=8,striker_bonus_coefficient={MaxHP:.1,AttackPower:.1,DefensePower:.05,HealPower:.05},gearId={Hat:1e3,Gloves:2e3,Shoes:3e3,Bag:4e3,Badge:5e3,Hairpin:6e3,Charm:7e3,Watch:8e3,Necklace:9e3};let userLang;if(localStorage.getItem("language")&&languages.includes(localStorage.getItem("language")))userLang=localStorage.getItem("language");else{let e;switch(window.navigator.language.split("-")[0]){case"ja":userLang="Jp";break;case"ko":userLang="Kr";break;default:userLang="En"}}const json_list={common:getCacheVerResourceName("./data/common.json"),raids:getCacheVerResourceName("./data/raids.json"),students:getCacheVerResourceName(`./data/students_${userLang.toLowerCase()}.json`),localization:getCacheVerResourceName("./data/localization.json"),stages:getCacheVerResourceName("./data/stages.json"),enemies:getCacheVerResourceName("./data/enemies.json"),items:getCacheVerResourceName(`./data/items_${userLang.toLowerCase()}.json`),furniture:getCacheVerResourceName("./data/furniture.json"),equipment:getCacheVerResourceName("./data/equipment.json"),crafting:getCacheVerResourceName("./data/crafting.json"),summons:getCacheVerResourceName("./data/summons.json")},html_list={craft:getCacheVerResourceName("./html/craft.html"),home:getCacheVerResourceName("./html/home.html"),items:getCacheVerResourceName("./html/items.html"),raids:getCacheVerResourceName("./html/raids.html"),stages:getCacheVerResourceName("./html/stages.html"),students:getCacheVerResourceName("./html/students.html")},sort_functions={Default:(e,t)=>(e.DefaultOrder-t.DefaultOrder)*search_options.sortby_dir,Name:(e,t)=>getTranslatedString(e,"Name").localeCompare(getTranslatedString(t,"Name"))*search_options.sortby_dir,AttackPower100:(e,t)=>(t.AttackPower100-e.AttackPower100)*search_options.sortby_dir,DefensePower100:(e,t)=>(t.DefensePower100-e.DefensePower100)*search_options.sortby_dir,MaxHP100:(e,t)=>(t.MaxHP100-e.MaxHP100)*search_options.sortby_dir,HealPower100:(e,t)=>(t.HealPower100-e.HealPower100)*search_options.sortby_dir,CriticalPoint:(e,t)=>(t.CriticalPoint-e.CriticalPoint)*search_options.sortby_dir,StabilityPoint:(e,t)=>(t.StabilityPoint-e.StabilityPoint)*search_options.sortby_dir,Range:(e,t)=>(t.Range-e.Range)*search_options.sortby_dir,AccuracyPoint:(e,t)=>(t.AccuracyPoint-e.AccuracyPoint)*search_options.sortby_dir,DodgePoint:(e,t)=>(t.DodgePoint-e.DodgePoint)*search_options.sortby_dir};let data={},loadedModule,student,studentList,loadedRaid,loadedItem,loadedStage,loadedCraftNode,region,regionID,student_bondalts,darkTheme,highContrast,raid,selectedEnemy=0,studentCompare,searchResultsCount=0,searchResultsSelection=0,studentSelectorModal,statPreviewModal,summonId=0,header,raid_difficulty=0,ta_difficulty=0,stat_preview_stars=3,stat_preview_weapon_stars=0,statPreviewIncludePassive=!1,statPreviewIncludeBond=!1,statPreviewIncludeBondAlts=!1,statPreviewIncludeEquipment=!1,statPreviewSupportStats=!1,statPreviewSummonStats=!1,compareMode=!1,selectCompareMode=!1,scrolling=!1,scrollPosition={top:0,left:0,x:0,y:0},search_options={groupby:"none",sortby:"Default",sortby_dir:1,filter:{SquadType:{Main:!1,Support:!1},TacticRole:{Tanker:!1,DamageDealer:!1,Healer:!1,Supporter:!1,Vehicle:!1},StarGrade:{3:!1,2:!1,1:!1},BulletType:{Explosion:!1,Pierce:!1,Mystic:!1},ArmorType:{LightArmor:!1,HeavyArmor:!1,Unarmed:!1},School:{Abydos:!1,Arius:!1,Gehenna:!1,Hyakkiyako:!1,Millennium:!1,RedWinter:!1,Shanhaijing:!1,Trinity:!1,Valkyrie:!1,SRT:!1,Others:!1},WeaponType:{SG:!1,SMG:!1,AR:!1,GL:!1,HG:!1,SR:!1,RG:!1,MG:!1,RL:!1,MT:!1},Position:{Front:!1,Middle:!1,Back:!1},IsLimited:{0:!1,1:!1,2:!1},StreetBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1},OutdoorBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1},IndoorBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1}}};class CharacterStats{constructor(e,t,a){this.stats={};let i=((t-1)/99).toFixed(4),s=Math.ceil((Math.round((e.MaxHP1+(e.MaxHP100-e.MaxHP1)*i).toFixed(4))*starscale_hp[a-1]).toFixed(4)),n=Math.ceil((Math.round((e.AttackPower1+(e.AttackPower100-e.AttackPower1)*i).toFixed(4))*starscale_attack[a-1]).toFixed(4)),r=Math.round((e.DefensePower1+(e.DefensePower100-e.DefensePower1)*i).toFixed(4)),l=Math.ceil((Math.round((e.HealPower1+(e.HealPower100-e.HealPower1)*i).toFixed(4))*starscale_healing[a-1]).toFixed(4));this.stats.MaxHP=[s,0,1],this.stats.AttackPower=[n,0,1],this.stats.DefensePower=[r,0,1],this.stats.HealPower=[l,0,1],this.stats.AccuracyPoint=[e.AccuracyPoint,0,1],this.stats.DodgePoint=[e.DodgePoint,0,1],this.stats.CriticalPoint=[e.CriticalPoint,0,1],this.stats.CriticalDamageRate=[e.CriticalDamageRate,0,1],this.stats.CriticalChanceResistPoint=[100,0,1],this.stats.CriticalDamageResistRate=[5e3,0,1],this.stats.StabilityPoint=[e.StabilityPoint,0,1],this.stats.AmmoCount=[e.AmmoCount,0,1],this.stats.AmmoCost=[e.AmmoCost,0,1],this.stats.Range=[e.Range,0,1],this.stats.RegenCost=[e.RegenCost,0,1],this.stats.HealEffectivenessRate=[1e4,0,1],this.stats.OppressionPower=[100,0,1],this.stats.OppressionResist=[100,0,1],this.stats.AttackSpeed=[1e4,0,1],this.stats.BlockRate=[1e4,0,1],this.stats.DefensePenetration=[1e4,0,1],this.stats.MoveSpeed=[1e4,0,1]}addBuff(e,t){let a=e.split("_");a.length>1?"Base"==a[1]?this.stats[a[0]][1]+=t:"Coefficient"==a[1]&&(this.stats[a[0]][2]+=t/1e4):this.stats[a[0]][1]+=t}addCharacterStatsAsBuff(e,t,a){this.stats[t][1]+=Math.round(e.getTotal(t)*(a/1e4))}getTotal(e){return Math.round(((this.stats[e][0]+this.stats[e][1])*this.stats[e][2]).toFixed(4))}getTotalString(e){let t=this.getTotal(e);return"Rate"==e.slice(-4)?(t/100).toFixed(0).toLocaleString()+"%":t.toLocaleString()}getStrikerBonus(e){return Math.floor(((this.stats[e][0]+this.stats[e][1])*this.stats[e][2]).toFixed(4)*striker_bonus_coefficient[e])}getStabilityMinDamage(){let e=this.getTotal("StabilityPoint");return parseFloat((100*(e/(e+997)+.2)).toFixed(2))+"%"}getDescriptionText(e){let t="";return t+="If this character's HP reaches 0, they will be unable to continue fighting.\n\n",t+=`Base Value: <b>${this.stats[e][0].toLocaleString()}</b>`,this.stats[e][1]>0&&(t+=`\nFlat Buffs: <b>+${this.stats[e][1].toLocaleString()}</b>`),this.stats[e][2]>1&&(t+=`\n% Buffs: <b>+${parseFloat((100*(this.stats[e][2]-1)).toFixed(2))}%</b>`),t}}function loadModuleFromURL(){var e=new URL(window.location.href).searchParams;e.get("chara")?loadStudent(e.get("chara")):e.get("charaid")?loadStudentById(e.get("charaid")):e.get("item")?loadItem(e.get("item")):e.get("raid")?loadRaid(e.get("raid")):e.get("stage")?loadStage(e.get("stage")):e.get("craftnode")?loadCraft(e.get("craftnode")):loadLastModule()}function loadLastModule(){localStorage.getItem("module")&&module_list.includes(localStorage.getItem("module"))?loadModule(localStorage.getItem("module")):loadModule("home")}function loadModule(e,t=null){if("students"==e)loadedModule="students",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-students").addClass("active"),$("#loaded-module").load(html_list.students,(function(){loadRegion(regionID),loadLanguage(userLang),studentSelectorModal=new bootstrap.Modal(document.getElementById("ba-student-modal-students"),{}),document.getElementById("ba-student-modal-students").addEventListener("hidden.bs.modal",(function(e){selectCompareMode=!1})),statPreviewSupportStats=!1,compareMode=!1,selectCompareMode=!1,$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;null!=t?loadStudent(t):e.has("chara")?loadStudent(e.get("chara")):e.has("charaid")?loadStudentById(e.get("charaid")):localStorage.getItem("chara")?loadStudent(localStorage.getItem("chara")):loadStudent("Aru"),populateStudentList(),localStorage.getItem("chara_groupby")?searchOptionSet("groupby",localStorage.getItem("chara_groupby"),!1):searchOptionSet("groupby","none",!1),localStorage.getItem("chara_sortby_dir")&&(search_options.sortby_dir=parseInt(localStorage.getItem("chara_sortby_dir"))),localStorage.getItem("chara_sortby")?searchSetOrder(localStorage.getItem("chara_sortby"),!1,!1):searchSetOrder("Default",!1,!1),Object.entries(search_options.filter).forEach(e=>{Object.entries(e[1]).forEach(t=>{!0===t[1]&&$(`#ba-student-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",!0)})}),activeFilters=getNumActiveFilters(),$("#ba-student-search-filter-amount").text(0==activeFilters?"":` (${activeFilters})`),$("#ba-student-search-reset").toggle(activeFilters>0),updateStudentList(updateSortMethod=!0),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),$("#ba-student, #ba-student-list-btn").show(),$("#ba-statpreview-status-bond-level").tooltip({title:getBasicTooltip("Toggle Relationship Bonus"),placement:"top",html:!0}),$("#ba-statpreview-status-equipment").tooltip({title:getBasicTooltip("Toggle Equipment Bonus"),placement:"top",html:!0}),$("#ba-statpreview-status-bond-alt-level").tooltip({title:getBasicTooltip("Toggle Alt Relationship Bonus"),placement:"top",html:!0}),$("#ba-statpreview-status-passive-level").tooltip({title:getBasicTooltip("Toggle Enhanced Skill Buff"),placement:"top",html:!0}),$("#ba-statpreview-status-strikerbonus").tooltip({title:getBasicTooltip("Support Stats"),placement:"top",html:!0}),$("#ba-statpreview-status-summon").tooltip({title:getBasicTooltip("Vehicle/Summon Stats"),placement:"top",html:!0}),$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip("Compare with Student"),placement:"top",html:!0}),$("#ba-student-search-reset").tooltip({title:getBasicTooltip("Clear All Filters"),placement:"top",html:!0}),$(".tooltip-button").on("click",e=>{"touch"==e.originalEvent.pointerType&&($(e.currentTarget),$(".tooltip").tooltip("hide"))})}));else if("items"==e){var a;loadedModule="items",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-items").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src="images/background/BG_CraftChamber_Night.jpg",$("#loaded-module").load(html_list.items,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;null!=t?loadItem(t):e.has("item")?loadItem(e.get("item")):localStorage.getItem("item")?loadItem(localStorage.getItem("item")):loadItem(1),populateItemList(),$(".ba-item-list").addClass("fade"),$(".ba-item-list.active").addClass("show"),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),$("#ba-item-list-container, #ba-item-details-container").show()}))}else if("raids"==e){loadedModule="raids",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-raids").addClass("active");let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src="images/background/BG_Raid.jpg",$("#loaded-module").load(html_list.raids,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");let e=new URL(window.location.href).searchParams;populateRaidList(),null!=t?loadRaid(t):e.has("raid")?loadRaid(e.get("raid")):localStorage.getItem("raid")?loadRaid(localStorage.getItem("raid")):loadRaid("Binah"),1==regionID&&($("#ba-raid-list-tab-timeattack").hide(),$("#ba-raid-list-tab-worldraid").hide(),$("#ba-raid-difficulty-5").hide()),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50)}))}else if("stages"==e){loadedModule="stages",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-stages").addClass("active");let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src="images/background/BG_Raid.jpg",$("#loaded-module").load(html_list.stages,(function(){loadLanguage(userLang),0==region.weaponlevel_max&&$("#ba-stages-list-tab-schooldungeon").hide(),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;populateStageList(),null!=t?loadStage(t):e.has("stage")?loadStage(e.get("stage")):localStorage.getItem("stage")?loadStage(localStorage.getItem("stage")):loadStage(1011101);let a=$(`#ba-stage-select-${loadedStage.Id}`).prop("offsetTop");$("#ba-stages-list-container .card-body").scrollTop(a),$(".ba-item-list").addClass("fade"),$(".ba-item-list.active").addClass("show"),makeDraggable($("#ba-stage-map")),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50)}))}else if("craft"==e){var a;loadedModule="craft",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-craft").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src="images/background/BG_CraftChamber_Night.jpg",$("#loaded-module").load(html_list.craft,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;null!=t?loadCraft(t):e.has("craftnode")?loadCraft(e.get("craftnode")):localStorage.getItem("craftnode")?loadCraft(localStorage.getItem("craftnode")):loadCraft(1),populateCraftList(),$(".ba-craft-list").addClass("fade"),$(".ba-craft-list.active").addClass("show"),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),$("#ba-craft-list-container, #ba-craft-details-container").show()}))}else{var a;loadedModule="home",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-home").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src="images/background/BG_View_Kivotos.jpg",$("#loaded-module").load(html_list.home,(function(){loadLanguage(userLang),loadRegion(regionID);let e="";$.each(data.common.changelog,(function(t,a){e+=`<h5 class="text-emphasis">${a.date}</h5><ul>`;for(let t=0;t<a.contents.length;t++)e+=`<li>${a.contents[t]}</li>`;e+="</ul>"})),$("#ba-home-modal-changelog-content").html(e);let t="Character Banner\n",a="",i=(new Date).getTime()/1e3,s={month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",timeZoneName:"short"},n=!1;$.each(data.common.regions[regionID].current_gacha,(function(e,r){if((i>=r.start&&i<r.end||i<=r.start)&&!n){for(let e=0;e<r.characters.length;e++){var l=find(data.students,"Id",r.characters[e])[0];a+=getStudentListCardHTML(l)}t+=new Date(1e3*r.start).toLocaleString([],s)+" - "+new Date(1e3*r.end).toLocaleString([],s),t+=`\n${i>=r.start?"Ends":"Starts"} in <b>${i>=r.start?duration(r.end-i):duration(r.start-i)}</b>.`,n=!0}})),$("#ba-home-gacha-text").html(t),$("#ba-home-gacha-list").html(a);let r="",l="";$("#ba-home-raid").hide(),n=!1,$.each(data.common.regions[regionID].current_raid,(function(e,t){if((i>=t.start&&i<t.end||i<=t.start)&&!n){if(t.raid>=1e3){r=getLocalizedString("StageType","timeattack")+"\n";let e=find(data.raids.TimeAttack,"Id",t.raid)[0];l+=getTimeAttackCardHTML(e,t.terrain)}else{r=getLocalizedString("StageType","raid")+"\n";let e=find(data.raids.Raid,"Id",t.raid)[0];l+=getRaidCardHTML(e,t.terrain)}$("#ba-home-raid").show(),r+=new Date(1e3*t.start).toLocaleString([],s)+" - "+new Date(1e3*t.end).toLocaleString([],s),r+=`\n${i>=t.start?"Ends":"Starts"} in <b>${i>=t.start?duration(t.end-i):duration(t.start-i)}</b>.`,n=!0}})),$("#ba-home-raid-text").html(r),$("#ba-home-raid-list").html(l);var o="",d=new Date;d.setHours(0,0,0,0);var c=new Date;if(c.setHours(0,0,0,0),c.setDate(d.getDate()+7),birthdayStudents=[],data.students.forEach(e=>{if(e.IsReleased[regionID]){var t=getNextBirthdayDate(e.BirthDay);t.getTime()<c.getTime()&&t.getTime()>=d.getTime()&&birthdayStudents.push(e)}}),birthdayStudents.length>0){birthdayStudents.sort((e,t)=>getNextBirthdayDate(e.BirthDay).getTime()-getNextBirthdayDate(t.BirthDay).getTime());for(let e=0;e<birthdayStudents.length;e++)o+='<div class="d-flex flex-column mx-1 mb-1">'+getStudentIconSmall(birthdayStudents[e])+'<div class="ba-panel mt-1 mx-1 p-1 text-center">'+getNextBirthdayDate(birthdayStudents[e].BirthDay).toLocaleDateString([],{month:"numeric",day:"numeric"})+"</div></div>";$("#ba-home-birthdays-list").html(o)}else $("#ba-home-birthdays").hide();$(".ba-item-student").tooltip({html:!0}),$("#ba-home-server-info").text(`Current Events (${getTranslatedString(data.common.regions[regionID],"Name")} Server)`),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50);let g=new URL(window.location.href);""!=g.searchParams.toString()&&(g.searchParams.forEach((e,t)=>g.searchParams.delete(t)),history.pushState(null,"",g)),document.title="Schale DB | Home",$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"})}))}localStorage.setItem("module",loadedModule)}function getNextBirthdayDate(e){var t=new Date;t.setHours(0,0,0,0);var a=new Date;return a.setHours(0,0,0,0),a.setMonth(parseInt(e.split("/")[0])-1,parseInt(e.split("/")[1])),a.setFullYear(a.getMonth()<t.getMonth()?t.getFullYear()+1:t.getFullYear()),a}function duration(e){let t=e,a=Math.floor(t/86400);t-=86400*a;let i=Math.floor(t/3600),s;return t-=3600*i,`${a} days, ${i} hours and ${Math.floor(t/60)} minutes`}function populateStudentList(){let e="";data.students.forEach(t=>{t.IsReleased[regionID]&&(e+=getStudentListCardHTML(t))}),e+='<div id="ba-student-select-noresult" class="p-2" style="font-size: medium;display:none;grid-column: 1/-1;">No results.</div>',$("#ba-student-select-grid").html(e)}function updateStudentList(e=!1){let t=$("#ba-student-search-text").val(),a=sort_functions[search_options.sortby],i=[];$.each(search_options.filter,(function(e,t){var a=!0,s=!0;$.each(t,(function(e,t){a=a&&!t,s=s&&t})),a||s||i.push(e)})),e&&studentList.sort(a);let s=0;$.each(studentList,(function(a,n){n.IsReleased[regionID]&&(e&&($("#ba-student-select-"+n.Id).css("order",a),"Default"==search_options.sortby||"Name"==search_options.sortby?($("#ba-student-select-"+n.Id+" .ba-label-text").text(getTranslatedString(n,"Name")).toggleClass("smalltext",getTranslatedString(n,"Name").length>label_smalltext_threshold[userLang]).toggleClass("ba-unhover-text",!1),$("#ba-student-select-"+n.Id+" .ba-hover-text").hide()):($("#ba-student-select-"+n.Id+" .ba-label-text").text(n[search_options.sortby]).toggleClass("smalltext",!1).toggleClass("ba-unhover-text",!0),$("#ba-student-select-"+n.Id+" .ba-hover-text").show())),checkFilters(n,i,t)?(s++,$("#ba-student-select-"+n.Id).show()):$("#ba-student-select-"+n.Id).hide())})),$("#ba-student-select-noresult").toggle(0==s)}function checkFilters(e,t,a){if(!e.IsReleased[regionID])return!1;if(0==t.length);else for(let a=0;a<t.length;a++)if(!search_options.filter[t[a]][e[t[a]]])return!1;return""==a||getTranslatedString(e,"Name").toLowerCase().includes(a.toLowerCase())}function searchOptionSet(e,t,a=!0){$(`#ba-student-search-${e} a`).removeClass("active"),$(`#ba-student-search-${e} button`).removeClass("active"),$(`#ba-student-search-${e}-${t}`).addClass("active"),$("#ba-student-search-sortby-stat").text(getLocalizedString("ui","stat")+" "),"sortby"==e&&"default"!=t&&"name"!=t&&($("#ba-student-search-sortby-stat").addClass("active"),$("#ba-student-search-sortby-stat").text($(`#ba-student-search-sortby-${t}`).text()+" ")),search_options[e]=t,localStorage.setItem(`chara_${e}`,t),a&&updateStudentList()}function getNumActiveFilters(){let e=0;return $.each(search_options.filter,(function(t,a){$.each(a,(function(t,a){!0===a&&(e+=1)}))})),e}function searchSetOrder(e,t=!0,a=!0){a&&(e==search_options.sortby?search_options.sortby_dir=-search_options.sortby_dir:search_options.sortby_dir=1),e in sort_functions||(e="Default"),$("#ba-student-search-sortby a").removeClass("active"),$("#ba-student-search-sortby button").removeClass("active"),$(`#ba-student-search-sortby-${e.toLowerCase()}`).addClass("active"),$("#ba-student-search-sortby-stat").text(getLocalizedString("ui","stat")),$(".sort-direction-label").text(""),$(`#ba-student-search-sortby-${e.toLowerCase()} > .sort-direction-label`).html(1==search_options.sortby_dir!=("Name"==e||"Default"==e)?'<i class="fa-solid fa-arrow-down-long ms-2"></i>':'<i class="fa-solid fa-arrow-up-long ms-2"></i>'),"Default"!=e&&"Name"!=e&&($("#ba-student-search-sortby-stat").addClass("active"),$("#ba-student-search-sortby-stat").html($(`#ba-student-search-sortby-${e.toLowerCase()}`).html())),search_options.sortby=e,localStorage.setItem("chara_sortby",e),localStorage.setItem("chara_sortby_dir",search_options.sortby_dir),t&&updateStudentList(updateSortMethod=!0)}function searchSetFilter(e,t,a=!0){search_options.filter[e][t]=!search_options.filter[e][t],$(`#ba-student-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).toggleClass("active",search_options.filter[e][t]),activeFilters=getNumActiveFilters(),$("#ba-student-search-filter-amount").text(0==activeFilters?"":` (${activeFilters})`),$("#ba-student-search-reset").toggle(activeFilters>0),a&&updateStudentList()}function searchResetFilter(){$("#ba-student-search-text").val(""),Object.entries(search_options.filter).forEach(e=>{Object.entries(e[1]).forEach(t=>{search_options.filter[e[0]][t[0]]=!1,$(`#ba-student-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",!1)})}),$("#ba-student-search-reset").hide(),$("#ba-student-search-filter-amount").text(""),document.getElementById("ba-student-search-reset").blur(),updateStudentList()}function processStudent(){$("#ba-student-img").attr("src",`images/student/portrait/Portrait_${student.DevName}.webp`);let e=new Image,t;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src=`images/background/${student.CollectionBG}.jpg`,$("#ba-student-name").html(getTranslatedString(student,"Name").replace(/([(（].+[)）])/,"<small>$1</small>")),$("#ba-student-class").text(getLocalizedString("SquadType",student.SquadType)).removeClass("ba-class-main ba-class-support").addClass(`ba-class-${student.SquadType.toLowerCase()}`),$("#ba-student-stargrade").html('<i class="fa-solid fa-star"></i>'.repeat(student.StarGrade)),student.IsLimited>0&&$("#ba-student-stargrade").append(`<span class="ms-1">(${getLocalizedString("IsLimited",""+student.IsLimited)})</span>`),statPreviewSummonStats=!1,$("#ba-statpreview-status-summon").toggleClass("deactivated",!0),$("#ba-statpreview-status-summon").toggle(student.SummonIds.length>0),$("#ba-student-role-label").text(getLocalizedString("TacticRole",student.TacticRole)),$("#ba-student-role-icon").attr("src",`images/ui/Role_${student.TacticRole}.png`),$(".ba-skill, .ba-weapon-skill-plus").removeClass("bg-skill-explosion bg-skill-pierce bg-skill-mystic").addClass(`bg-skill-${student.BulletType.toLowerCase()}`),$("#ba-student-attacktype").removeClass("bg-atk-explosion bg-atk-pierce bg-atk-mystic").addClass(`bg-atk-${student.BulletType.toLowerCase()}`),$("#ba-student-defensetype").removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed").addClass(`bg-def-${student.ArmorType.toLowerCase()}`),$("#ba-student-school-label").text(student.School),$("#ba-student-school-img").attr("src",`images/schoolicon/School_Icon_${student.School.toUpperCase()}_W.png`),$("#ba-student-position-label").text(student.Position.toUpperCase()),$("#ba-student-attacktype-label").text(getLocalizedString("BulletType",student.BulletType)),$("#ba-student-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",student.BulletType)}`,getLocalizedString("ui","attacktype"),null,getAttackTypeText(student.BulletType),32),placement:"top",html:!0}),$("#ba-student-defensetype-label").text(getLocalizedString("ArmorType",student.ArmorType)),$("#ba-student-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",student.ArmorType)}`,getLocalizedString("ui","defensetype"),null,getDefenseTypeText(student.ArmorType),32),placement:"top",html:!0}),updateGearIcon(),$("#ba-student-usescover-icon").toggle(student.Cover),$("#ba-student-weapontype-label").text(student.WeaponType),$(".ba-type-weapon").css("background-image",`url('images/weapon/${student.WeaponImg}.png')`),student.Skills.forEach(e=>{$(`#ba-skill-${e.SkillType}-name`).text(getTranslatedString(e,"Name")),$(`#ba-skill-${e.SkillType}-icon`).attr("src",`images/skill/${e.Icon}.png`),"passive"==e.SkillType&&$("#ba-statpreview-passiveskill-icon, #ba-statpreview-status-passive-icon").attr("src",`images/skill/${e.Icon}.png`),"ex"==e.SkillType&&($("#ba-statpreview-exskill-icon").attr("src",`images/skill/${e.Icon}.png`),$("#ba-skill-ex-cost").removeClass("ba-col-explosion ba-col-pierce ba-col-mystic"),e.Cost[0]!=e.Cost[4]&&$("#ba-skill-ex-cost").addClass(`ba-col-${student.BulletType.toLowerCase()}`))});for(let e=2;e<=5;e++)t="",$.each(student.SkillExMaterial[e-2],(function(a,i){t+=getMaterialIconHTML(i,student.SkillExMaterialAmount[e-2][a])})),t+=getMaterialIconHTML(3000001,abbreviateNumber(skill_ex_upgrade_credits[e-2])),$("#ba-skill-ex-materials-"+e).html(t),$("#ba-skill-ex-materials-"+e+" div").each((function(e,t){$(t).tooltip({html:!0})}));for(let e=2;e<=9;e++)t="",$.each(student.SkillMaterial[e-2],(function(a,i){t+=getMaterialIconHTML(i,student.SkillMaterialAmount[e-2][a])})),t+=getMaterialIconHTML(3000001,abbreviateNumber(skill_upgrade_credits[e-2])),$("#ba-skill-materials-"+e).html(t),$("#ba-skill-materials-"+e+" div").each((function(e,t){$(t).tooltip({html:!0})}));t="",t+=getMaterialIconHTML(9999,1),t+=getMaterialIconHTML(3000001,abbreviateNumber(skill_upgrade_credits[8])),$("#ba-skill-materials-10").html(t),$("#ba-skill-materials-10 div").each((function(e,t){$(t).tooltip({html:!0})})),$("#ba-student-weapon-name, #ba-statpreview-weapon-name").text(getTranslatedString(student.Weapon,"Name")),$("#ba-weapon-description").text(getTranslatedString(student.Weapon,"Desc").replace("\n\n","\n")),$("#ba-student-weapon-type").text(student.WeaponType),$("#ba-student-weapon-img, #ba-statpreview-weapon-img").attr("src",`images/weapon/${student.WeaponImg}.png`),$("#ba-weapon-bonus-terrain-type").attr("src",`images/ui/Terrain_${student.Weapon.AdaptationType}.png`);let a=getLocalizedString("AdaptationAmount",String(student[student.Weapon.AdaptationType+"BattleAdaptation"])),i=getLocalizedString("AdaptationAmount",String(student[student.Weapon.AdaptationType+"BattleAdaptation"]+student.Weapon.AdaptationValue));$("#ba-weapon-bonus-terrain-adaption").attr("src",`images/ui/Ingame_Emo_Adaptresult${i}.png`),$("#ba-weapon-bonus-terrain-adaption-description").html(`${getLocalizedString("ui","terrain_adaption",[getLocalizedString("AdaptationType",student.Weapon.AdaptationType)])} ${a} → <b>${i}</b><br>(${getAdaptationText(student.Weapon.AdaptationType,i)})`),$("#ba-weapon-stat-row2").toggle(student.Weapon.HealPower1>0),"Jp"!=userLang?$("#ba-student-fullname").text(getTranslatedString(student,"FamilyName")+" "+getTranslatedString(student,"PersonalName")):$("#ba-student-fullname").text(getTranslatedString(student,"FamilyName")+getTranslatedString(student,"PersonalName")),$("#ba-profile-school-label").text(getLocalizedString("SchoolLong",student.School)),$("#ba-profile-club-label").text(getLocalizedString("Club",student.Club)),$("#ba-profile-schoolyear-label").text(getTranslatedString(student,"SchoolYear")).toggle(""!=getTranslatedString(student,"SchoolYear")),$("#ba-profile-portrait-img").attr("src",`images/student/collection/${student.CollectionTexture}.webp`);var s="";s+=getTranslatedString(student,"ProfileIntroduction"),3==student.StarGrade&&(s+=`\n\n<i class="text-bold">"${getTranslatedString(student,"CharacterSSRNew")}"</i>`),$("#ba-student-profile-text").html(s),student.MemoryLobby>0?($(".ba-student-lobby").show(),$("#ba-student-lobby-img").attr("src",`images/student/lobby/Lobbyillust_Icon_${student.DevName}_01.png`),$("#ba-student-lobby-unlock").text(student.MemoryLobby),$(".ba-student-lobby").tooltip("dispose").tooltip({title:getRichTooltip(null,getLocalizedString("ui","memory_lobby_student",[getTranslatedString(student,"Name")]),null,null,getLocalizedString("ui","memory_lobby_unlock",[student.MemoryLobby,getTranslatedString(student,"Name")])),placement:"top",html:!0})):$(".ba-student-lobby").hide(),$("#ba-student-profile-age").text(getTranslatedString(student,"CharacterAge")),$("#ba-student-profile-birthday").text(getTranslatedString(student,"Birthday")),$("#ba-student-profile-hobbies").text(getTranslatedString(student,"Hobby")),$("#ba-student-profile-height").text(student.CharHeightMetric),$("#ba-student-profile-cv").text(getTranslatedString(student,"CharacterVoice")),$("#ba-student-profile-illustrator").text(student.ArtistName);let n=student.FavorItemTags;n.push(student.FavorItemUniqueTags[0]);let r=getFavouriteItems(n),l="";$(r[0]).each((function(e,t){l+=getFavourIconHTML(t,3)})),$(r[1]).each((function(e,t){l+=getFavourIconHTML(t,2)})),$("#ba-student-favoured-items").empty().html(l),""==l?$("#ba-student-favoured-items").empty().html(`<span class="pb-2 text-center">${getLocalizedString("ui","favoritem_none")}</span>`):$("#ba-student-favoured-items").empty().html(l);let o="";$(student.FurnitureInteraction).each((function(e,t){let a=find(data.furniture,"Id",t)[0];a.IsReleased[regionID]&&(o+=getFurnitureIconHTML(a))})),$("#ba-student-favoured-furniture").empty().html(o),""==o?$("#ba-student-favoured-furniture").empty().html(`<span class="pb-2 text-center">${getLocalizedString("ui","furniture_none")}</span>`):$("#ba-student-favoured-furniture").empty().html(o),$(".ba-favor-item").tooltip({html:!0}),$("#ba-student-bond-1").text(getStatName(student.FavorStatType[0])),$("#ba-student-bond-2").text(getStatName(student.FavorStatType[1])),"Main"==student.SquadType?($("#ba-student-stat-table").removeClass("table-striker-bonus"),$("#ba-statpreview-status-strikerbonus").hide(),statPreviewSupportStats=!1):$("#ba-statpreview-status-strikerbonus").show(),$("#ba-statpreview-status-strikerbonus").toggleClass("deactivated",!statPreviewSupportStats),$("#ba-statpreview-bond-targets").empty().html(getBondTargetsHTML(1,student)),$("#ba-statpreview-status-bond-icon").attr("src",`images/student/icon/${student.CollectionTexture}.png`),student_bondalts=[];for(let e=0;e<student.FavorAlts.length;e++){var d=find(data.students,"Id",student.FavorAlts[e])[0];d.IsReleased[regionID]&&(student_bondalts.push(d),$("#ba-statpreview-status-bond-alt-icon").attr("src",`images/student/icon/${d.CollectionTexture}.png`),$("#ba-statpreview-bond-targets").append(getBondTargetsHTML(1+student_bondalts.length,d)))}$("#ba-statpreview-status-bond-alt-level").toggle(student_bondalts.length>0),updateStatPreviewTitle(),document.title=`Schale DB | ${getTranslatedString(student,"Name")}`,$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"}),changeStatPreviewStars(stat_preview_stars,stat_preview_weapon_stars,!1),recalculateTerrainAffinity(),updatePassiveSkillStatPreview(),updateSummonExSkillStatPreview(),recalculateWeaponPreview(),updateWeaponLevelStatPreview($("#ba-statpreview-weapon-range").val()),recalculateSkillPreview(),recalculateWeaponSkillPreview(),recalculateEXSkillPreview(),recalculateBondPreview(),changeGearLevel(1,document.getElementById("ba-statpreview-gear1-range"),!1),changeGearLevel(2,document.getElementById("ba-statpreview-gear2-range"),!1),changeGearLevel(3,document.getElementById("ba-statpreview-gear3-range"),!1);for(let e=1;e<=student_bondalts.length+1;e++)changeStatPreviewBondLevel(e,document.getElementById(`ba-statpreview-bond-${e}-range`),!1);recalculateStatPreview();var c=new URL(window.location.href);c.searchParams.get("chara")!==student.DevName&&(c.searchParams.forEach((e,t)=>c.searchParams.delete(t)),c.searchParams.set("chara",student.DevName),history.pushState(null,"",c)),localStorage.setItem("chara",student.DevName),studentSelectorModal.hide()}function loadStudent(e){"students"==loadedModule?selectCompareMode?(studentCompare=find(data.students,"DevName",e)[0],selectCompareMode=!1,compareMode=!0,statPreviewSummonStats&&(statPreviewSummonStats=!1,$("#ba-statpreview-status-summon").toggleClass("deactivated",!0)),recalculateStatPreview(),studentSelectorModal.hide(),updateStatPreviewTitle()):(student=find(data.students,"DevName",e),1==student.length&&(student=student[0],compareMode&&student.Id==studentCompare.Id&&(compareMode=!1),processStudent())):loadModule("students",e)}function loadStudentById(e){"students"==loadedModule?(student=find(data.students,"Id",e),console.log(student),1==student.length&&(student=student[0],processStudent())):loadModule("students")}function toggleStudentSummon(){statPreviewSummonStats=!statPreviewSummonStats,statPreviewSupportStats&&statPreviewSummonStats&&toggleStrikerBonus(),compareMode&&(compareMode=!1,$("#ba-statpreview-status-compare").toggleClass("deactivated",!0)),recalculateStatPreview(),$("#ba-statpreview-status-summon").toggleClass("deactivated",!statPreviewSummonStats),updateStatPreviewTitle()}function loadItem(e){if("items"==loadedModule){var t="",a;$(".tooltip").tooltip("hide"),$("#ba-item-furniture-row").hide(),e>=2e6?(t="equipment",a=findOrDefault(data.equipment,"Id",e-2e6,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.Category))):e>=1e6?(t="furniture",a=findOrDefault(data.furniture,"Id",e-1e6,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.SubCategory)),$("#ba-item-furniture-row").show(),$("#ba-item-furniture-set").html(0==a.SetGroupId?"":`・ <i>${getLocalizedString("furniture_set",String(a.SetGroupId))}</i>`),$("#ba-item-furniture-comfort").html("+"+a.ComfortBonus)):(t="items",a=findOrDefault(data.items,"Id",e,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.Category))),loadedItem=a,$("#ba-item-name").html(getTranslatedString(a,"Name")),"equipment"==t&&a.Id>=1e3?$("#ba-item-rarity").html(`T${a.Id%10+1}`):$("#ba-item-rarity").html(getRarityStars(a.Rarity)),$("#ba-item-icon").removeClass("ba-item-n ba-item-r ba-item-sr ba-item-ssr").addClass("ba-item-"+a.Rarity.toLowerCase()),$("#ba-item-icon-img").attr("src",`images/${t}/${a.Icon}.png`),$("#ba-item-description").html(getTranslatedString(a,"Desc")),"equipment"==t&&a.Id>=1e3&&a.Id<=1e4&&$("#ba-item-description").append(`\n\n<b>${getLocalizedString("ui","stat_info")}:</b>\n`+getGearStatsText(a,"\n")),a.Category.includes("WeaponExpGrowth")&&$("#ba-item-description").append(`\n\n<i>${getLocalizedString("WeaponPartExpBonus",a.Category)}</i>`),$("#ba-equipment-recipe").empty().hide(),$("#ba-item-usage").empty().hide(),$("#ba-item-sources").empty().hide(),"Material"==a.Category||"CharacterExpGrowth"==a.Category?($("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-sources").html(getItemDropStages(a.Id)),$("#ba-item-list-tab-materials").tab("show")):"Favor"==a.Category?("SSR"!=a.Rarity?($("#ba-item-usage").html(getLikedByStudents(a)),$(".ba-item-student").tooltip({html:!0})):$("#ba-item-usage").html("<i>This gift will be treated as a favorite item when given to any student.</i>").show(),$("#ba-item-list-tab-gifts").tab("show")):"SecretStone"==a.Category?($("#ba-item-sources").html(getItemDropStages(a.Id)),$("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-list-tab-eleph").tab("show")):"equipment"==t?($("#ba-item-usage").html(getUsedByStudents(a,t)),$("#ba-item-sources").html(getItemDropStages(a.Id+2e6)),$("#ba-equipment-recipe").html(getEquipmentRecipe(a)),$("#ba-equipment-recipe div").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-list-tab-equipment").tab("show")):"Coin"==a.Category&&($("#ba-item-sources").html(getItemDropStages(a.Id)),$("#ba-item-list-tab-currency").tab("show")),"furniture"==t&&($("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-list-tab-furniture").tab("show"));var i=new URL(window.location.href);i.searchParams.get("item")!=e&&(i.searchParams.forEach((e,t)=>i.searchParams.delete(t)),i.searchParams.set("item",e),history.pushState(null,"",i)),document.title=`Schale DB | ${getTranslatedString(a,"Name")}`,$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"}),localStorage.setItem("item",e)}else loadModule("items",e)}function loadCraft(e){if("craft"==loadedModule){let a="craftnode",i=findOrDefault(data.crafting.Nodes,"Id",e,1)[0];loadedCraftNode=i,$("#ba-craft-name").html(getTranslatedString(i,"Name")),$("#ba-craft-type").html(getLocalizedString("NodeTier",""+i.Tier)),$("#ba-craft-rarity").html(getLocalizedString("NodeQuality",""+i.Quality)),$("#ba-craft-icon").removeClass("ba-node-quality-1 ba-node-quality-2").addClass("ba-node-quality-"+i.Quality),$("#ba-craft-icon-img").attr("src",`images/ui/${i.Icon}.png`),$("#ba-craft-description").html(getTranslatedString(i,"Desc")),$("#ba-craft-rewards").empty();let s="";$.each(i.Groups,(function(e,t){let a=data.crafting.Groups[t.GroupId],n=0;for(let e=0;e<a.length;e++)n+=a[e].Weight;for(let e=0;e<a.length;e++){let r=(t.Weight/i.Weight*(a[e].Weight/n)).toFixed(4),l=a[e].ItemId;"Furniture"==a[e].Type?l+=1e6:"Equipment"==a[e].Type&&(l+=2e6),s+=getDropIconHTML(l,r)}})),$("#ba-craft-rewards").html(s),$("#ba-craft-rewards div").each((function(e,t){$(t).tooltip({html:!0})}));var t=new URL(window.location.href);t.searchParams.get("craftnode")!=e&&(t.searchParams.forEach((e,a)=>t.searchParams.delete(a)),t.searchParams.set("craftnode",e),history.pushState(null,"",t)),document.title=`Schale DB | ${getTranslatedString(i,"Name")}`,$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"}),localStorage.setItem("craftnode",e)}else loadModule("craft",e)}function loadRaid(e){if(selectedEnemy=0,"raids"==loadedModule){NaN==parseInt(e)&&(e=1),1==regionID&&e>=1e3&&(e=1),loadedRaid&&$("#ba-raid-select-"+loadedRaid.Id).removeClass("selected"),e<1e3?($("#ba-raid-list-tab-raid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").hide(),$("#ba-raid-difficulty").show(),raid=findOrDefault(data.raids.Raid,"Id",e,1)[0],raid.IsReleasedInsane[regionID]?$("#ba-raid-difficulty-5").toggleClass("disabled",!1):($("#ba-raid-difficulty-5").toggleClass("disabled",!0),5==raid_difficulty&&(raid_difficulty=0)),$(`#ba-raid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(raid.Faction),$("#ba-raid-name").text(getTranslatedString(raid,"Name")),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),raid.IsReleasedInsane[regionID]||5!=raid_difficulty||(raid_difficulty=0),changeRaidDifficulty(raid_difficulty)):e<8e5?($("#ba-raid-list-tab-timeattack").tab("show"),$("#ba-raid-info").hide(),$("#ba-timeattack-info").show(),raid=findOrDefault(data.raids.TimeAttack,"Id",e,1e3)[0],$(`#ba-timeattack-difficulty-${ta_difficulty}`).tab("show"),$("#ba-timeattack-name").text(getTranslatedString(raid,"Name")),$("#ba-timeattack-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain}.png`),changeTimeAttackDifficulty(ta_difficulty)):($("#ba-raid-list-tab-worldraid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").show(),$("#ba-raid-difficulty").hide(),raid=findOrDefault(data.raids.WorldRaid,"Id",e,1)[0],raid_difficulty>2&&(raid_difficulty=0),$(`#ba-worldraid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(getLocalizedString("StageType","worldraid")),$("#ba-raid-name").text(getTranslatedString(raid,"Name")),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),changeWorldRaidDifficulty(raid_difficulty)),loadedRaid=raid,$("#ba-raid-select-"+raid.Id).addClass("selected");let t=new URL(window.location.href);t.searchParams.get("raid")!=raid.Id&&(t.searchParams.forEach((e,a)=>t.searchParams.delete(a)),t.searchParams.set("raid",raid.Id),history.pushState(null,"",t)),document.title=`Schale DB | ${getTranslatedString(raid,"Name")}`,$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"}),localStorage.setItem("raid",raid.Id)}else loadModule("raids",e)}function changeRaidDifficulty(e){raid_difficulty=e;let t="",a="";$("#ba-raid-header").css("background-image",`url('images/raid/Boss_Portrait_${raid.DevName}${5==raid_difficulty?"_Insane":""}_Lobby.png')`),$("#ba-raid-level").text(`Lv. ${raid_level[raid_difficulty]}`),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0),raid.EnemyList[raid_difficulty].forEach((function(e,t){let i=find(data.enemies,"Id",e)[0];a+=`<button class="nav-link ${t==selectedEnemy?"active":""}" data-bs-toggle="tab" href="#" onclick="changeRaidEnemy(${t})">${getTranslatedString(i,"Name")}</button>`})),$("#ba-raid-enemy-tabs").empty().html(a),raid.RaidSkill.forEach((function(e,a){raid_difficulty<e.MinDifficulty||(""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-center mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/raid/skill/${e.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(e,"Name")}</h4></div><div class="mt-1"><p class="d-inline" style="font-style: italic;">${e.SkillType} Skill</p>${e.ATGCost>0?'<p class="d-inline text-bold"> ・ <i>ATG Cost:</i> '+e.ATGCost+"</p>":""}</div></div></div><p class="mt-1 mb-2 p-1">${getSkillText(getTranslatedString(e,"Desc"),e.Parameters,raid_difficulty+1,"raid")}</p>`)})),$("#ba-raid-skills").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}));let i="";i+=getDropIconHTML(7,raid_reward_coin[raid_difficulty][0]),1!=regionID&&0!=raid_reward_coin[raid_difficulty][1]&&(i+=getDropIconHTML(9,raid_reward_coin[raid_difficulty][1])),$("#ba-raid-rewards").html(`<div class="d-flex flex-wrap justify-content-center">${i}</div>`),$("#ba-raid-rewards>div div").each((e,t)=>{$(t).tooltip({html:!0})}),changeRaidEnemy(selectedEnemy)}function changeTimeAttackDifficulty(e){ta_difficulty=e;let t="",a="";$("#ba-timeattack-level").text(`Lv.${raid.EnemyLevel[ta_difficulty]}`),raid.EnemyList[ta_difficulty].forEach((function(e,t){let i=find(data.enemies,"Id",raid.EnemyList[ta_difficulty][t])[0];a+=getEnemyCardHTML(i,raid.EnemyLevel[ta_difficulty],1,1)})),$("#ba-stage-enemies").html(a),$("#ba-stage-enemies > :first").trigger("click"),raid.Rules.forEach((function(e,a){ta_difficulty<e.MinDifficulty||(""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-start mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/timeattack/${e.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(e,"Name")}</h4><p class="mt-1 mb-2 p-1">${getSkillText(getTranslatedString(e,"Desc"),[],0,"raid")}</p></div></div></div>`)})),$("#ba-timeattack-rules").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function changeWorldRaidDifficulty(e){raid_difficulty=e;let t="",a="";$("#ba-raid-header").css("background-image",`url('images/raid/${raid.Icon}.png')`),$("#ba-raid-level").text(`Lv. ${raid.Level[raid_difficulty]}`),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0),raid.EnemyList[raid_difficulty].forEach((function(e,t){let i=find(data.enemies,"Id",e)[0];a+=`<button class="nav-link ${t==selectedEnemy?"active":""}" data-bs-toggle="tab" href="#" onclick="changeRaidEnemy(${t})">${getTranslatedString(i,"Name")}</button>`})),$("#ba-raid-enemy-tabs").empty().html(a),raid.RaidSkill.forEach((function(e,a){raid_difficulty<e.MinDifficulty||(""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-center mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/raid/skill/${e.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(e,"Name")}</h4></div><div class="mt-1"><p class="d-inline" style="font-style: italic;">${e.SkillType} Skill</p>${e.ATGCost>0?'<p class="d-inline text-bold"> ・ <i>ATG Cost:</i> '+e.ATGCost+"</p>":""}</div></div></div><p class="mt-1 mb-2 p-1">${getSkillText(getTranslatedString(e,"Desc"),e.Parameters,raid_difficulty+1,"raid")}</p>`)})),$("#ba-raid-skills").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}));let i="";raid.Rewards[raid_difficulty].forEach(e=>{i+=getDropIconHTML(e[0],e[1])}),$("#ba-raid-rewards").html(`<div class="d-flex flex-wrap justify-content-center">${i}</div>`),$("#ba-raid-rewards>div div").each((e,t)=>{$(t).tooltip({html:!0})}),changeRaidEnemy(selectedEnemy)}function changeRaidEnemy(e){selectedEnemy=e;let t=find(data.enemies,"Id",raid.EnemyList[raid_difficulty][e])[0],a=1,i;i=raid.Id<1e3?raid_level[raid_difficulty]:raid.Level[raid_difficulty];let s=((i-1)/99).toFixed(4),n=Math.ceil((Math.round((t.MaxHP1+(t.MaxHP100-t.MaxHP1)*s).toFixed(4))*starscale_hp[0]).toFixed(4)),r=Math.ceil((Math.round((t.AttackPower1+(t.AttackPower100-t.AttackPower1)*s).toFixed(4))*starscale_attack[0]).toFixed(4)),l=Math.round((t.DefensePower1+(t.DefensePower100-t.DefensePower1)*s).toFixed(4));$("#ba-raid-stat-maxhp").text(n.toLocaleString()),$("#ba-raid-stat-attack").text(r.toLocaleString()),$("#ba-raid-stat-defense").text(l.toLocaleString()),$("#ba-raid-stat-dmgresist").text(`${parseFloat(((t.DamagedRatio-1e4)/100).toFixed(4)).toLocaleString()}%`),$("#ba-raid-stat-accuracy").text(t.AccuracyPoint.toLocaleString()),$("#ba-raid-stat-evasion").text(t.DodgePoint.toLocaleString()),$("#ba-raid-stat-crit").text(t.CriticalPoint.toLocaleString()),$("#ba-raid-stat-critdmg").text(`${parseFloat((t.CriticalDamageRate/100).toFixed(4)).toLocaleString()}%`),$("#ba-raid-stat-critresist").text(t.CriticalResistPoint.toLocaleString()),$("#ba-raid-stat-critdmgresist").text(`${parseFloat((t.CriticalDamageResistRate/100).toFixed(4))}%`);let o=raid_difficulty<5?raid.BulletType:raid.BulletTypeInsane;$("#ba-raid-attacktype").removeClass("bg-atk-explosion bg-atk-pierce bg-atk-mystic bg-atk-normal").addClass(`bg-atk-${o.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",o)}`,getLocalizedString("ui","attacktype"),null,getAttackTypeText(o),32),placement:"top",html:!0}),$("#ba-raid-attacktype-label").text(getLocalizedString("BulletType",o)),$("#ba-raid-defensetype").removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed bg-def-normal").addClass(`bg-def-${t.ArmorType.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",t.ArmorType)} Armor`,getLocalizedString("ui","defensetype"),null,getDefenseTypeText(t.ArmorType),32),placement:"top",html:!0}),$("#ba-raid-defensetype-label").text(getLocalizedString("ArmorType",t.ArmorType));let d=getEnemySize(t);$("#ba-raid-enemy-size").text(getLocalizedString("EnemyTags",d)).toggle(null!=d)}function getEnemySize(e){let t=e.Tags.filter(e=>e.includes("Enemy"));return 0==t.length?null:t[0]}function loadStage(e){if("stages"==loadedModule){let t="";loadedStage&&$("#ba-stage-select-"+loadedStage.Id).removeClass("selected"),e>=7e6?(t="Event",stage=findOrDefault(data.stages.Event,"Id",e,8012301)[0],$("#ba-stages-list-tab-events").tab("show")):e>=1e6?(t="Campaign",stage=findOrDefault(data.stages.Campaign,"Id",e,1011101)[0],$("#ba-stages-list-tab-missions").tab("show")):e>=6e4?(t="SchoolDungeon",stage=findOrDefault(data.stages.SchoolDungeon,"Id",e,60101)[0],$("#ba-stages-list-tab-schooldungeon").tab("show")):e>=31e3?(t="WeekDungeon",stage=findOrDefault(data.stages.WeekDungeon,"Id",e,31101)[0],$("#ba-stages-list-tab-commissions").tab("show")):e>=3e4?(t="WeekDungeon",stage=findOrDefault(data.stages.WeekDungeon,"Id",e,30101)[0],$("#ba-stages-list-tab-bounty").tab("show")):(t="Campaign",stage=find(data.stages.Campaign,"Id",1011101)[0],$("#ba-stages-list-tab-missions").tab("show")),$("#ba-stage-drops-tabs").toggle("WeekDungeon"!=t),"WeekDungeon"==t&&$("#ba-stage-drops-default-tab").tab("show"),loadedStage=stage,$("#ba-stage-name").html(getStageName(stage,t)),$("#ba-stage-title").html(getStageTitle(stage,t)),$("#ba-stage-level").text(getLocalizedString("ui","rec_level")+" Lv."+stage.Level),$("#ba-stage-terrain-img").attr("src",`images/ui/Terrain_${stage.Terrain}.png`),$("#ba-stage-fog").toggle("Campaign"==t&&1==stage.Difficulty);let a=new URL(window.location.href);a.searchParams.get("stage")!=e&&(a.searchParams.forEach((e,t)=>a.searchParams.delete(t)),a.searchParams.set("stage",e),history.pushState(null,"",a));const i=["Default","FirstClear","ThreeStar"];i.forEach(e=>{if(e in stage.Rewards&&stage.Rewards[e].length>0){let t="";1==regionID&&"RewardsGlobal"in stage?$.each(stage.RewardsGlobal[e],(function(e,a){t+=getDropIconHTML(a[0],a[1])})):$.each(stage.Rewards[e],(function(e,a){t+=getDropIconHTML(a[0],a[1])})),$(`#ba-stage-drops-${e.toLowerCase()}`).html(`<div class="d-flex flex-wrap justify-content-center">${t}</div>`),"FindGift"==stage.Type&&$(`#ba-stage-drops-${e.toLowerCase()}`).prepend('<i class="d-block mb-2">Each enemy defeated will drop one of the following items</i><div class="d-flex flex-wrap justify-content-center"></div>'),$(`#ba-stage-drops-${e.toLowerCase()}>div div`).each((function(e,t){$(t).tooltip({html:!0})}))}else $(`#ba-stage-drops-${e.toLowerCase()}`).html('<div class="d-flex flex-wrap justify-content-center"><span class="pb-2 text-center">No rewards.</span></div>')});let s="",n={};const r=["Minion","Elite","Champion","Boss"];if(stage.Formations.forEach(e=>{for(let t=0;t<e.EnemyList.length;t++){let a=find(data.enemies,"Id",e.EnemyList[t])[0],i=r.indexOf(a.Rank);n[`${4-i}_${a.Id}_${e.Level[i]}_${e.Grade[i]}`]=a}}),Object.keys(n).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],s+=getEnemyCardHTML(n[e],e_level,e_grade)}),$("#ba-stage-enemies").html(s),$("#ba-stage-enemies > :first").trigger("click"),"HexaMap"in stage?($("#ba-stage-tab-map").toggleClass("disabled",!1),drawHexamap(stage),$("#ba-stage-star-1").html(getLocalizedString("ui","starcondition_complete")),$("#ba-stage-star-2").html(getLocalizedString("ui","starcondition_sranks",[stage.StarCondition[0]])),$("#ba-stage-star-3").html(getLocalizedString("ui","starcondition_clearturns",[stage.StarCondition[1]]))):($("#ba-stage-tab-map").hasClass("active")&&$("#ba-stage-tab-enemies").tab("show"),$("#ba-stage-tab-map").toggleClass("disabled",!0),"Campaign"==t||"Event"==t?($("#ba-stage-star-1").html(getLocalizedString("ui","starcondition_defeatall")),$("#ba-stage-star-2").html(getLocalizedString("ui","starcondition_defeatalltime",["120"])),$("#ba-stage-star-3").html(getLocalizedString("ui","starcondition_allsurvive"))):"Chaser"==stage.Type.slice(0,6)?($("#ba-stage-star-1").html(getLocalizedString("ui","starcondition_clear")),$("#ba-stage-star-2").html(getLocalizedString("ui","starcondition_allsurvive")),$("#ba-stage-star-3").html(getLocalizedString("ui","starcondition_cleartime",["150"]))):"Blood"==stage.Type?($("#ba-stage-star-1").html(getLocalizedString("ui","starcondition_clear")),$("#ba-stage-star-2").html(getLocalizedString("ui","starcondition_allsurvive")),$("#ba-stage-star-3").html(getLocalizedString("ui","starcondition_cleartime",["120"]))):"FindGift"==stage.Type?($("#ba-stage-star-1").html(getLocalizedString("ui","starcondition_earnrewards",["1"])),$("#ba-stage-star-2").html(getLocalizedString("ui","starcondition_earnrewards",["4"])),$("#ba-stage-star-3").html(getLocalizedString("ui","starcondition_earnrewards",["5"]))):"School"==stage.Type.slice(0,6)&&($("#ba-stage-star-1").html(getLocalizedString("ui","starcondition_clear")),$("#ba-stage-star-2").html(getLocalizedString("ui","starcondition_allsurvive")),$("#ba-stage-star-3").html(getLocalizedString("ui","starcondition_cleartime",["120"])))),"EntryCost"in stage&&stage.EntryCost.length>0){let e;e=stage.EntryCost[0][0]<20?find(data.common.currency,"Id",stage.EntryCost[0][0])[0]:find(data.items,"Id",stage.EntryCost[0][0])[0],$("#ba-stage-entrycost").tooltip("dispose").tooltip({title:getRichTooltip(`images/items/${e.Icon}.png`,getTranslatedString(e,"Name"),getLocalizedString("ItemCategory","Currency"),getRarityStars(e.Rarity),getTranslatedString(e,"Desc"),50,"img-scale-larger"),placement:"top",html:!0}),$("#ba-stage-entrycost img").attr("src",`images/items/${e.Icon}.png`),$("#ba-stage-entrycost .label").html(`&times;${stage.EntryCost[0][1]}`)}$("#ba-stage-map-enemies").html('<p class="mb-0">Click on an enemy unit on the map to view a list of enemies.</p>'),$("#ba-stage-select-"+stage.Id).addClass("selected"),document.title=`Schale DB | ${$("#ba-stage-title").text()}`,$("#ba-navbar-content").collapse("hide"),localStorage.setItem("stage",e)}else loadModule("stages",e)}function getStageName(e,t){switch(t){case"Event":return`${getLocalizedString("EventName",""+e.EventId)}\n${1==e.Difficulty?"Quest":"Challenge"} ${e.Stage.toString().padStart(2,"0")}`;case"Campaign":return`${e.Area}-${e.Stage} ${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageType",e.Type)}`}return console.log(`No name definition for stage type ${t}`),"undefined!!!"}function getStageTitle(e,t){switch(t){case"Event":case"Campaign":return getTranslatedString(e,"Name");case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageTitle",e.Type,String.fromCharCode(64+e.Stage))}`}return console.log(`No title definition for stage type ${t}`),"undefined!!!"}function getEventStage(e){let t=e.toString().slice(0,3),a=find(data.stages.events,"Id",t);if(a.length>0){let t=find(a[0].Stages,"Id",e);if(t.length>0)return t[0]}return data.stages.events[0].Stages[0]}function loadRegion(e){regionID=e,region=data.common.regions[regionID],$("#ba-statpreview-levelrange").attr("max",region.studentlevel_max),$("#ba-weaponpreview-levelrange, #ba-statpreview-weapon-range").attr("max",region.weaponlevel_max),0==region.weaponlevel_max&&($("#ba-student-nav-weapon").hide(),$("#ba-statpreview-weapon").hide(),$("#ba-weaponpreview-star-1").hide(),$("#ba-weaponpreview-star-2").hide(),$("#ba-weaponpreview-star-3").hide(),stat_preview_weapon_stars=0),$("#ba-bond-levelrange").attr("max",region.bondlevel_max),$("#ba-statpreview-gear1-range").attr("max",region.gear1_max),$("#ba-statpreview-gear2-range").attr("max",region.gear2_max),$("#ba-statpreview-gear3-range").attr("max",region.gear3_max),1==regionID&&($("#ba-student-search-filter-school-srt").hide(),$("#ba-student-search-filter-school-arius").hide(),$("#ba-student-search-filter-weapontype-rl").hide())}function getAdaptationText(e,t){return getLocalizedString("ui","terrain_adaption_details",[terrain_dmg_bonus[t],getLocalizedString("AdaptationType",e).toLowerCase(),terrain_block_bonus[t]])}function getStatName(e){return getLocalizedString("Stat",e.replace("_Coefficient","").replace("_Base","").replace("100","").replace("1",""))}function getFormattedStatAmount(e){return Number.isInteger(e)?e:`${parseFloat((100*e).toFixed(2))}%`}function changeGearLevel(e,t,a=!0){let i=student.Equipment[e-1],s=parseInt(t.value),n=find(data.equipment,"Id",gearId[i]+s-1)[0];$(`#ba-statpreview-gear${e}-icon`).attr("src",`images/equipment/Equipment_Icon_${i}_Tier${s}.png`),$(`#ba-statpreview-gear${e}-level`).text(`T${s}`),$(`#ba-statpreview-gear${e}-name`).text(getTranslatedString(n,"Name")),$(`#ba-statpreview-gear${e}-description`).html(getGearStatsText(n)),statPreviewIncludeEquipment&&(a&&recalculateStatPreview(),updateGearIcon())}function getEquipmentId(e,t){return find(data.equipment,"Category",e)[t-1]}function getGearStatsText(e,t=", "){let a=[];for(let t=0;t<e.StatType.length;t++){let i=e.StatValue[t][1];"Coefficient"==e.StatType[t].split("_")[1]&&(i=parseFloat((i/100).toFixed(2))+"%"),a.push(`${getStatName(e.StatType[t])} +<b>${i}</b>`)}return a.join(t)}function toggleStrikerBonus(){statPreviewSupportStats=!statPreviewSupportStats,statPreviewSupportStats&&statPreviewSummonStats&&toggleStudentSummon(),$("#ba-student-stat-table").toggleClass("table-striker-bonus",statPreviewSupportStats),$("#ba-statpreview-status-strikerbonus").toggleClass("deactivated",!statPreviewSupportStats),recalculateStatPreview()}function changeStatPreviewLevel(e){$("#ba-statpreview-level").text("Lv."+e.value),recalculateStatPreview()}function changeSkillPreviewLevel(e){e.value==e.max?$("#ba-skill-level").html('<img src="images/ui/ImageFont_Max.png" style="height: 18px;width: auto;margin-top: -2px;">'):$("#ba-skill-level").html("Lv."+e.value),recalculateSkillPreview()}function changeWeaponSkillPreviewLevel(e){e.value==e.max?$("#ba-weapon-skill-level").html('<img src="images/ui/ImageFont_Max.png" style="height: 18px;width: auto;margin-top: -2px;">'):$("#ba-weapon-skill-level").html("Lv."+e.value),recalculateWeaponSkillPreview()}function changeEXSkillPreviewLevel(e){e.value==e.max?$("#ba-skill-ex-level").html('<img src="images/ui/ImageFont_Max.png" style="height: 18px;width: auto;margin-top: -2px;">'):$("#ba-skill-ex-level").html("Lv."+e.value),recalculateEXSkillPreview()}function changeWeaponPreviewLevel(e){$("#ba-weaponpreview-level").text("Lv."+e.value),recalculateWeaponPreview()}function changeStatPreviewBondLevel(e,t,a=!0){var i;$(`#ba-statpreview-bond-${e}-level`).html(`<i class="fa-solid fa-heart"></i> ${t.value}`),i=1==e?Object.entries(getBondStats(student,t.value)):Object.entries(getBondStats(student_bondalts[e-2],t.value)),$(`#ba-statpreview-bond-${e}-description`).html(`${getStatName(i[0][0])} <b>+${getFormattedStatAmount(i[0][1])}</b>, ${getStatName(i[1][0])} <b>+${getFormattedStatAmount(i[1][1])}</b>`),a&&recalculateStatPreview()}function changeStatPreviewWeaponLevel(e){updateWeaponLevelStatPreview(e.value),recalculateStatPreview()}function updateWeaponLevelStatPreview(e){$("#ba-statpreview-weapon-level, #ba-student-weapon-level").html("Lv."+e);let t=getWeaponStats(student,e),a="";$(Object.entries(t)).each((function(e,t){t[1]>0&&(a+=`${getStatName(t[0])} <b>+${getFormattedStatAmount(t[1])}</b>, `)})),$("#ba-statpreview-weapon-description").html(a.substring(0,a.length-2))}function changeStatPreviewPassiveSkillLevel(e){e.value==e.max?$("#ba-statpreview-passiveskill-level").html('<img src="images/ui/ImageFont_Max.png" style="height: 18px;width: auto;margin-top: -2px;">'):$("#ba-statpreview-passiveskill-level").html("Lv."+e.value),updatePassiveSkillStatPreview(),recalculateStatPreview()}function changeStatPreviewSummonExSkillLevel(e){e.value==e.max?$("#ba-statpreview-exskill-level").html('<img src="images/ui/ImageFont_Max.png" style="height: 18px;width: auto;margin-top: -2px;">'):$("#ba-statpreview-exskill-level").html("Lv."+e.value),updateSummonExSkillStatPreview(),recalculateStatPreview()}function getBondTargetsHTML(e,t){return`<div class="mt-2 mb-1 d-flex flex-row align-items-center"><div class="me-3" style="position: relative;"><img class="ba-bond-icon ms-0" src="images/student/icon/${t.CollectionTexture}.png"></div><div class="flex-fill"><h5 class="d-inline">${getTranslatedString(t,"Name")}</h5><p id="ba-statpreview-bond-${e}-description" class="mb-0" style="font-size: 0.875rem; line-height: 1rem;"></p></div></div><div class="d-flex flex-row align-items-center mb-2"><input id="ba-statpreview-bond-${e}-range" oninput="changeStatPreviewBondLevel(${e}, this)" type="range" class="form-range me-2 flex-fill" value="20" min="1" max="${region.bondlevel_max}"><span id="ba-statpreview-bond-${e}-level" class="ba-slider-label"></span></div>`}function changeBondLevel(e){$("#ba-bond-level").html('<i class="fa-solid fa-heart"></i> '+e.value),recalculateBondPreview()}function updateGearIcon(){let e,t,a="";for(let i=1;i<=3;i++)t=statPreviewIncludeEquipment?$(`#ba-statpreview-gear${i}-range`).val():1,a+=(""==a?"":" / ")+"T"+$(`#ba-statpreview-gear${i}-range`).val(),e=find(data.equipment,"Id",gearId[student.Equipment[i-1]]+(t-1))[0],$("#ba-student-gear-"+i).attr("src",`images/equipment/Equipment_Icon_${e.Category}_Tier${t}.png`).tooltip("dispose").tooltip({title:getRichTooltip(`images/equipment/Equipment_Icon_${e.Category}_Tier${t}.png`,getTranslatedString(e,"Name"),getLocalizedString("ItemCategory",e.Category),`T${t}`,getTranslatedString(e,"Desc")+`\n\n<b>${getLocalizedString("ui","stat_info")}:</b>\n`+getGearStatsText(e,"\n"),50,"img-scale-larger"),placement:"top",html:!0}).toggleClass("gear-disabled",!statPreviewIncludeEquipment),$("#ba-student-gear-"+i).attr("onclick",`loadItem(${e.Id+2e6})`)}function recalculateTerrainAffinity(){let e;["Street","Outdoor","Indoor"].forEach(e=>{let t=getLocalizedString("AdaptationAmount",String(student[`${e}BattleAdaptation`]+(5==stat_preview_stars&&stat_preview_weapon_stars>=3&&student.Weapon.AdaptationType==e?student.Weapon.AdaptationValue:0)));$(`#ba-student-terrain-${e.toLowerCase()}-icon`).attr("src",`images/ui/Ingame_Emo_Adaptresult${t}.png`),$(`#ba-student-terrain-${e.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(`images/ui/Ingame_Emo_Adaptresult${t}.png`,getLocalizedString("ui","terrain_adaption",[getLocalizedString("AdaptationType",e)])+" "+t,null,null,getAdaptationText(e,t),30),placement:"top",html:!0})})}function recalculateWeaponPreview(){let e=$("#ba-weaponpreview-levelrange").val(),t=getWeaponStats(student,e);$("#ba-weapon-stat-attack-amount").text("+"+t.AttackPower),$("#ba-weapon-stat-maxhp-amount").text("+"+t.MaxHP),$("#ba-weapon-stat-healing-amount").text("+"+t.HealPower)}function recalculateStatPreview(){const e=[0,15,35],t=[10,10,20,20,50];let a=$("#ba-student-stat-table").hasClass("table-striker-bonus"),i=$("#ba-statpreview-levelrange").val(),s,n,r;if(statPreviewSummonStats&&(r=find(data.summons,"Id",student.SummonIds[0])[0],n=new CharacterStats(r,i,r.StarBonus?stat_preview_stars:1)),s=new CharacterStats(student,i,stat_preview_stars),compareMode&&(studentCompareStats=new CharacterStats(studentCompare,i,stat_preview_stars)),statPreviewIncludeEquipment){let t,a;for(let l=0;l<3;l++){if(a=parseInt($(`#ba-statpreview-gear${l+1}-range`).val()),t=find(data.equipment,"Id",gearId[student.Equipment[l]]+a-1)[0],i>=e[l])for(let e=0;e<t.StatType.length;e++)s.addBuff(t.StatType[e],t.StatValue[e][1]),statPreviewSummonStats&&99999!=r.Id&&n.addBuff(t.StatType[e],t.StatValue[e][1]);if(compareMode&&(t=find(data.equipment,"Id",gearId[studentCompare.Equipment[l]]+a-1)[0],i>=e[l]))for(let e=0;e<t.StatType.length;e++)studentCompareStats.addBuff(t.StatType[e],t.StatValue[e][1])}}if(statPreviewIncludeBond){let e=$("#ba-statpreview-bond-1-range").val(),a=getBondStats(student,Math.min(t[stat_preview_stars-1],e));Object.entries(a).forEach(e=>{s.addBuff(e[0],e[1])}),compareMode&&(a=getBondStats(studentCompare,Math.min(t[stat_preview_stars-1],e)),Object.entries(a).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if(statPreviewIncludeBondAlts)for(let e=2;e<=student_bondalts.length+1;e++){let t=$(`#ba-statpreview-bond-${e}-range`).val(),a=getBondStats(student_bondalts[e-2],t);Object.entries(a).forEach(e=>{s.addBuff(e[0],e[1])})}if(statPreviewIncludePassive&&!statPreviewSupportStats){let e=find(student.Skills,"SkillType",(stat_preview_weapon_stars>=2?"weapon":"")+"passive")[0],t=getPassiveSkillBonus(e,$("#ba-statpreview-passiveskill-range").val());Object.entries(t).forEach(e=>{s.addBuff(e[0],e[1])}),compareMode&&(e=find(studentCompare.Skills,"SkillType",(stat_preview_weapon_stars>=2?"weapon":"")+"passive")[0],t=getPassiveSkillBonus(e,$("#ba-statpreview-passiveskill-range").val()),Object.entries(t).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if(5==stat_preview_stars&&stat_preview_weapon_stars>0){let e=getWeaponStats(student,$("#ba-statpreview-weapon-range").val());Object.entries(e).forEach(e=>{s.addBuff(e[0],e[1]),statPreviewSummonStats&&99999!=r.Id&&n.addBuff(e[0],e[1])}),compareMode&&(e=getWeaponStats(studentCompare,$("#ba-statpreview-weapon-range").val()),Object.entries(e).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if(statPreviewSummonStats&&!compareMode){let e=$("#ba-statpreview-exskill-range").val();for(let t=0;t<student.Skills[0].SummonStat.length;t++)n.addCharacterStatsAsBuff(s,student.Skills[0].SummonStat[t],student.Skills[0].SummonStatCoefficient[t][e-1])}"Support"==student.SquadType&&(s.stats.AmmoCount[0]=0),compareMode&&"Support"==studentCompare.SquadType&&(studentCompareStats.stats.AmmoCount[0]=0);const l=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalDamageRate","StabilityPoint","Range","OppressionPower","OppressionResist","AmmoCount","CriticalChanceResistPoint","CriticalDamageResistRate","HealEffectivenessRate"];let o=statPreviewSummonStats?n:s;l.forEach((e,t)=>{let i;if(a&&!statPreviewSummonStats&&t<4)i="+"+o.getStrikerBonus(e).toLocaleString();else if("AmmoCount"==e){let e=o.getTotalString("AmmoCount"),t=o.getTotalString("AmmoCost");i=0==e?"N/A":`${e}&nbsp;(${t})`}else i=o.getTotalString(e);if(compareMode){let t,s;t=a?"Support"!=studentCompare.SquadType?o.getStrikerBonus(e):o.getStrikerBonus(e)-studentCompareStats.getStrikerBonus(e):o.getTotal(e)-studentCompareStats.getTotal(e),s="Rate"==e.slice(-4)?`${parseFloat(Math.abs(t/100).toFixed(1)).toLocaleString()}%`:`${Math.abs(t).toLocaleString()}`,i+=t<0?`<small class="comparison less">&#9660;&nbsp;${s}</small>`:t>0?`<small class="comparison greater">&#9650;&nbsp;${s}</small>`:'<small class="comparison">&#9654;&nbsp;0</small>'}$(`#ba-student-stat-${e} .stat-value`).html(i)}),$("#ba-statpreview-status-bond-level").toggleClass("deactivated",!statPreviewIncludeBond),$("#ba-statpreview-status-bond-level .statpreview-label").html(`<i class="fa-solid fa-heart me-1"></i> ${$("#ba-statpreview-bond-1-range").val()}`),student_bondalts.length>0&&($("#ba-statpreview-status-bond-alt-level").toggleClass("deactivated",!statPreviewIncludeBondAlts),$("#ba-statpreview-status-bond-alt-level .statpreview-label").html(`<i class="fa-solid fa-heart me-1"></i> ${$("#ba-statpreview-bond-2-range").val()}`)),$("#ba-statpreview-status-passive-level").toggleClass("deactivated",!statPreviewIncludePassive),$("#ba-statpreview-status-equipment").toggleClass("deactivated",!statPreviewIncludeEquipment),$("#ba-statpreview-status-compare").toggleClass("deactivated",!compareMode)}function recalculateEXSkillPreview(){let e=$("#ba-skillpreview-exrange").val(),t=find(student.Skills,"SkillType","ex")[0];$("#ba-skill-ex-description").html(getSkillText(getTranslatedString(t,"Desc"),t.Parameters,e,student.BulletType)),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-skill-ex-materials").hide(),$("#ba-skill-ex-materials-"+e).show(),$("#ba-skill-ex-cost").text(t.Cost[e-1])}function recalculateSkillPreview(){let e=$("#ba-skillpreview-range").val(),t;["normal","passive","sub"].forEach(t=>{let a=find(student.Skills,"SkillType",t)[0];$(`#ba-skill-${t}-description`).html(getSkillText(getTranslatedString(a,"Desc"),a.Parameters,e,student.BulletType))}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-skill-materials").hide(),$("#ba-skill-materials-"+e).show()}function getStudentListCardHTML(e){let t=getTranslatedString(e,"Name"),a;return`\n    <div id="ba-student-select-${e.Id}" class="ba-select-grid-item unselectable">\n        <div onclick="loadStudent('${e.DevName}')" class="ba-student-card">\n            <div class="ba-student-card-portrait"><img class="ba-student-card-portrait-img" src="images/student/collection/${e.CollectionTexture}.webp"></div>\n            <span class="ba-student-card-role bg-${e.SquadType.toLowerCase()}-t"><img src="images/ui/Role_${e.TacticRole}.png" style="width:100%"></span>\n            <span class="ba-student-card-atk bg-atk-${e.BulletType.toLowerCase()}-t"><img src="images/ui/Type_Attack_s.png" style="width:100%;"></span>\n            <span class="ba-student-card-def bg-def-${e.ArmorType.toLowerCase()}-t"><img src="images/ui/Type_Defense_s.png" style="width:100%;"></span>\n            <img class="ba-student-card-star" style="right: 2px; top: 2px;" src="images/ui/Common_Icon_Formation_Star_R${e.StarGrade}.png">\n            <div class="d-flex align-items-center ba-student-card-label">\n                <span class="ba-label-text px-1 align-middle ${t.length>label_smalltext_threshold[userLang]?"smalltext":""}" style="width: 100%">${t}</span>\n                <span class="ba-hover-text px-1 align-middle ${t.length>label_smalltext_threshold[userLang]?"smalltext":""}" style="display: none; width: 100%">${t}</span>\n            </div>\n        </div>\n    </div>`}function getItemCardHTML(e,t,a){var i;return`<div id="ba-item-select-${e.Id}" class="ba-select-grid-item unselectable" title="${getBasicTooltip(getTranslatedString(e,"Name"))}"><div onclick="loadItem('${t}')" class="ba-item-card"><div class="ba-item-card-img"><img class="ba-item-${e.Rarity.toLowerCase()}" loading="lazy" src="images/${a}/${e.Icon}.png"></div></div></div>`}function getStageCardHTML(e,t=0){let a="";a=e.Id>=7e6?"Event":e.Id>=1e6?"Campaign":e.Id>=6e4?"SchoolDungeon":e.Id>=3e4?"WeekDungeon":"Unknown";let i=n(e);var s=`<div id="ba-stage-select-${e.Id}" class="ba-select-grid-item unselectable">\n    <div onclick="loadStage('${e.Id}')" class="ba-stage-card">\n    <div class="ba-stage-card-img"><img loading="lazy" src="images/campaign/${getStageIcon(e,a)}.png"></div>`;return t>0&&(s+=`<span class="ba-stage-card-droprate">${getProbabilityText(t)}</span>`),s+='<div class="d-flex align-items-center ba-select-grid-card-label">',s+=`<span class="ba-label-text px-1 align-middle ${i.length>label_enemy_smalltext_threshold[userLang]?"smalltext":""}" style="width: 100%">${i}</span>`,s+="</div></div></div>";function n(){switch(a){case"Event":return`${1==e.Difficulty?"Quest":"Challenge"} ${e.Stage.toString().padStart(2,"0")}`;case"Campaign":return`${e.Area}-${e.Stage} ${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageTitle",e.Type,[String.fromCharCode(64+e.Stage)])}`}}}function getStageIcon(e,t){switch(t){case"Event":return`Campaign_Event_${e.EventId>1e4?e.EventId-1e4:e.EventId}_${1==e.Difficulty?"Normal":"Hard"}`;case"Campaign":return`Campaign_Image_${e.Area.toString().padStart(2,"0")}_${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":return`WeekDungeon_Image_${e.Type}`;case"SchoolDungeon":return`SchoolDungeon_Image_${e.Type}`}}function getRaidCardHTML(e,t=""){let a=getTranslatedString(e,"Name"),i=`<div id="ba-raid-select-${e.Id}" class="ba-select-grid-item unselectable"><div onclick="loadRaid(${e.Id});" class="ba-raid-card"><div class="ba-raid-card-bg-container"><div class="ba-raid-card-bg" style="background-image:url('images/raid/${e.IconBG}.png');"></div></div><div class="ba-raid-card-img"><img src="images/raid/${e.Icon}.png"></div><div class="ba-raid-card-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense.png" style="width:100%;"></div>`;return""!=t&&(i+=`<div class="ba-raid-card-terrain"><img class="invert-light" src="images/ui/Terrain_${t}.png"></div>`),i+=`<div class="d-flex align-items-center ba-select-grid-card-label"><span class="ba-label-text px-1 align-middle ${a.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}" style="width: 100%">${getTranslatedString(e,"Name")}</span></div></div></div>`,i}function getTimeAttackCardHTML(e){let t=getTranslatedString(e,"Name"),a=`<div id="ba-raid-select-${e.Id}" class="ba-select-grid-item unselectable"><div onclick="loadRaid(${e.Id});" class="ba-raid-card"><div class="ba-raid-card-bg-container"><div class="ba-raid-card-bg" style="background-image:url('images/timeattack/${e.IconBG}.png');"></div></div><div class="ba-ta-card-img"><img src="images/enemy/${e.Icon}.png"></div><div class="ba-raid-card-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense.png" style="width:100%;"></div><div class="ba-raid-card-terrain"><img class="invert-light" src="images/ui/Terrain_${e.Terrain}.png"></div>`;return a+=`<div class="d-flex align-items-center ba-select-grid-card-label"><span class="ba-label-text px-1 align-middle ${t.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}" style="width: 100%">${t}</span></div></div></div>`,a}function getEnemyCardHTML(e,t,a,i=0,s=!0){var n=`<div class="ba-icon-enemy unselectable" ${s?`data-enemy='${e.Id}_${t}_${a}_${i}'`:""} onclick="showEnemyInfo(${e.Id},${t},${a},${i},${!s})"><img src="images/enemy/${e.Icon}.png">`;return"Elite"==e.Rank?n+='<span class="ba-enemy-card-rank"><img src="images/ui/Common_Icon_Enemy_Elite.png" style="width:22px;"></span>':"Champion"==e.Rank&&(n+='<span class="ba-enemy-card-rank"><img src="images/ui/Common_Icon_Enemy_Champion.png" style="width:31px;"></span>'),n+=`<span class="ba-enemy-card-lv">Lv.${t}</span><span class="ba-enemy-card-atk bg-atk-${e.BulletType.toLowerCase()}"><img src="images/ui/Type_Attack_s.png" style="width:100%;"></span>\n    <span class="ba-enemy-card-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="width:100%;"></span><div class="d-flex align-items-center ba-select-grid-card-label"><span class="ba-label-text px-1 align-middle ${getTranslatedString(e,"Name").length>label_enemy_smalltext_threshold[userLang]?"smalltext":""}" style="width: 100%">${getTranslatedString(e,"Name")}</span></div></div>`}function showEnemyInfo(e,t,a=1,i=0,s=!1){$(".ba-icon-enemy").removeClass("selected"),"stages"==loadedModule&&s&&$("#ba-stage-tab-enemies").tab("show"),$(`.ba-icon-enemy[data-enemy='${e}_${t}_${a}_${i}']`).addClass("selected");let n=find(data.enemies,"Id",e)[0];$("#ba-stage-enemy-name").text(getTranslatedString(n,"Name")),$("#ba-stage-enemy-img").attr("src",`images/enemy/${n.Icon}.png`),$("#ba-stage-enemy-rank").text(`Lv.${t} ${getLocalizedString("EnemyRank",n.Rank)}`),$("#ba-stage-enemy-class").text(getLocalizedString("SquadType",n.SquadType)).removeClass("ba-class-main ba-class-support").addClass(`ba-class-${n.SquadType.toLowerCase()}`);let r=getEnemySize(n),l;$("#ba-stage-enemy-size").text(getLocalizedString("EnemyTags",r)).toggle(null!=r),$("#ba-stage-enemy-attacktype").removeClass("bg-atk-normal bg-atk-explosion bg-atk-pierce bg-atk-mystic").addClass(`bg-atk-${n.BulletType.toLowerCase()}`),$("#ba-stage-enemy-defensetype").removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed bg-def-normal").addClass(`bg-def-${n.ArmorType.toLowerCase()}`),$("#ba-stage-enemy-attacktype-label").text(getLocalizedString("BulletType",n.BulletType)),$("#ba-stage-enemy-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",n.BulletType)}`,getLocalizedString("ui","attacktype"),null,getAttackTypeText(n.BulletType),32),placement:"top",html:!0}),$("#ba-stage-enemy-defensetype-label").text(getLocalizedString("ArmorType",n.ArmorType)),$("#ba-stage-enemy-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",n.ArmorType)} Armor`,getLocalizedString("ui","defensetype"),null,getDefenseTypeText(n.ArmorType),32),placement:"top",html:!0}),0==i?l=((t-1)/99).toFixed(4):1==i&&(l=getTimeAttackLevelScale(t));let o=Math.ceil((Math.round((n.MaxHP1+(n.MaxHP100-n.MaxHP1)*l).toFixed(4))*starscale_hp[a-1]).toFixed(4)),d=Math.ceil((Math.round((n.AttackPower1+(n.AttackPower100-n.AttackPower1)*l).toFixed(4))*starscale_attack[a-1]).toFixed(4)),c=Math.round((n.DefensePower1+(n.DefensePower100-n.DefensePower1)*l).toFixed(4)),g=Math.ceil((Math.round((n.HealPower1+(n.HealPower100-n.HealPower1)*l).toFixed(4))*starscale_healing[a-1]).toFixed(4));$("#ba-stage-enemy-stat-maxhp").text(o.toLocaleString()),$("#ba-stage-enemy-stat-attack").text(d.toLocaleString()),$("#ba-stage-enemy-stat-defense").text(c.toLocaleString()),$("#ba-stage-enemy-stat-healing").text(g.toLocaleString()),$("#ba-stage-enemy-stat-accuracy").text(n.AccuracyPoint.toLocaleString()),$("#ba-stage-enemy-stat-evasion").text(n.DodgePoint.toLocaleString()),$("#ba-stage-enemy-stat-crit").text(n.CriticalPoint.toLocaleString()),$("#ba-stage-enemy-stat-critdmg").text(`${parseFloat((n.CriticalDamageRate/100).toFixed(4)).toLocaleString()}%`),$("#ba-stage-enemy-stat-stability").text(n.StabilityPoint.toLocaleString()),$("#ba-stage-enemy-stat-range").text(n.Range.toLocaleString()),"Main"==n.SquadType?$("#ba-stage-enemy-stat-ammo").text(n.AmmoCount+" ("+n.AmmoCost+")"):$("#ba-stage-enemy-stat-ammo").text("N/A"),$("#ba-stage-enemy-stat-critresist").text(n.CriticalResistPoint.toLocaleString()),$("#ba-stage-enemy-stat-critdmgresist").text(`${parseFloat((n.CriticalDamageResistRate/100).toFixed(4))}%`),$("#ba-stage-enemy-stat-movespeed").text(n.MoveSpeed.toLocaleString())}function populateMapEnemyList(e){let t={};const a=["Minion","Elite","Champion","Boss"];let i=find(loadedStage.Formations,"Id",e)[0],s="";for(let e=0;e<i.EnemyList.length;e++){let s=find(data.enemies,"Id",i.EnemyList[e])[0],n=a.indexOf(s.Rank);t[`${4-n}_${s.Id}_${i.Level[n]}_${i.Grade[n]}`]=s}Object.keys(t).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],s+=getEnemyCardHTML(t[e],e_level,e_grade,0,!1)}),$("#ba-stage-map-enemies").html(s),window.scrollTo({top:$("#ba-stage-map-enemies").prop("offsetTop"),left:0})}function getMaterialIconHTML(e,t){var a,i;return i=`<div class="drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${(a=e>=3e6?find(data.common.currency,"Id",e-3e6)[0]:find(data.items,"Id",e)[0]).Id})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/items/${a.Icon}.png`,getTranslatedString(a,"Name"),getLocalizedString("ItemCategory",a.Category),getRarityStars(a.Rarity),getTranslatedString(a,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${a.Rarity.toLowerCase()}" src="images/items/${a.Icon}.png"><span class="ba-material-label" style="cursor:pointer;">&times;${t}</span></div>`}function getDropIconHTML(e,t){let a,i,s,n;if(e>=4e6){if(groups=find(data.common.GachaGroup,"Id",e-4e6),!(groups.length>0))return"";s=groups[0],i="GachaGroup",iconPath="items",n=!1}else e>=3e6?(a=find(data.common.currency,"Id",e-3e6)[0],i="Currency",iconPath="items",n=!1):e>=2e6?(a=find(data.equipment,"Id",e-2e6)[0],i="Equipment",iconPath="equipment",n=!0):e>=1e6?(a=find(data.furniture,"Id",e-1e6)[0],i="Furniture",iconPath="furniture",n=!0):(a=find(data.items,"Id",e)[0],i="Item",iconPath="items",n=!0);let r="";a&&(r="Equipment"==i&&a.Id>=1e3?`T${a.Id%10+1}`:getRarityStars(a.Rarity));let l="";if("GachaGroup"==i){let e="N";if(1==s.ItemList.length)return getDropIconHTML(s.ItemList[0][0],t<1?t:s.ItemList[0][3]);{let a,i,n;if(s.Id>=6e5&&s.Id<7e5){i="Random ",n="Contains one of the following equipment pieces:\n",iconPath="equipment";let e="";for(let t=0;t<s.ItemList.length;t++){let r=find(data.equipment,"Id",s.ItemList[t][0]-2e6)[0];n+=getTranslatedString(r,"Name")+"\n",a=r.Icon,e=getLocalizedString("ItemCategory",r.Category),i+=`${t>0?"/":""}T${r.Id%10+1}`}i+=" "+e}else if(s.Id>=10100&&s.Id<=10103){a=s.Icon,i=getTranslatedString(s,"Name"),n="Contains one of the following artifacts:\n",e=s.Rarity;for(let e=0;e<s.ItemList.length;e++){let t;n+=getTranslatedString(find(data.items,"Id",s.ItemList[e][0])[0],"Name")+"\n"}}l=`<div class="drop-shadow" style="position: relative; data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/${iconPath}/${a}.png`,i,getLocalizedString("ItemCategory","Box"),"",n,50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.toLowerCase()}" src="images/${iconPath}/${a}.png"><span class="ba-material-label">${getProbabilityText(t)}</span></div>`}}else l=`<div class="drop-shadow" style="position: relative; ${n?'cursor:pointer;" onclick="loadItem('+e+')"':'"'} data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/${iconPath}/${a.Icon}.png`,getTranslatedString(a,"Name"),getLocalizedString("ItemCategory",a.Category),r,getTranslatedString(a,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${a.Rarity.toLowerCase()}" src="images/${iconPath}/${a.Icon}.png"><span class="ba-material-label" ${n?'style="cursor:pointer;"':""}>${getProbabilityText(t)}</span></div>`;return l}function formatString(e,t=[]){return e.replace(/\{([0-9]+)\}/g,(e,a)=>a<t.length?t[a]:"")}function getProbabilityText(e){return e>=1?"&times;"+abbreviateNumber(parseInt(e).toFixed(0)).toLocaleString():parseFloat((100*e).toFixed(2))+"&#37;"}function getStudentIconSmall(e){var t;return`<div class="ba-item-student drop-shadow d-inline-block" style="position: relative; cursor: pointer;" data-bs-toggle="tooltip" data-bs-placement="top" onclick="loadStudent('${e.DevName}')" title="${getRichTooltip(`images/student/icon/${e.CollectionTexture}.png`,getTranslatedString(e,"Name"),getLocalizedString("ui","student"),getRarityStars(e.StarGrade),getTranslatedString(e,"ProfileIntroduction").split("\n")[0],50,"circle")}"><img src="images/student/icon/${e.CollectionTexture}.png"></div>`}function getFavourIconHTML(e,t){var a=find(data.items,"Id",5e3+e)[0],i;return`<div class="ba-favor-item drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${a.Id})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/items/${a.Icon}.png`,getTranslatedString(a,"Name"),getLocalizedString("ItemCategory",a.Category),getRarityStars(a.Rarity),getTranslatedString(a,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${a.Rarity.toLowerCase()}" src="images/items/${a.Icon}.png"><img class="ba-favor-label" src="images/ui/Cafe_Interaction_Gift_0${t}.png"></div>`}function getFurnitureIconHTML(e){var t;return`<div class="ba-favor-item drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${e.Id+1e6})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/furniture/${e.Icon}.png`,getTranslatedString(e,"Name"),getLocalizedString("ItemCategory",e.Category),getRarityStars(e.Rarity),getTranslatedString(e,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.Rarity.toLowerCase()} mb-2" src="images/furniture/${e.Icon}.png"></div>`}function recalculateWeaponSkillPreview(){let e=$("#ba-weapon-skillpreview-range").val(),t=find(student.Skills,"SkillType","weaponpassive")[0];$("#ba-skill-weaponpassive-description").html(getSkillText(getTranslatedString(t,"Desc"),t.Parameters,e,student.BulletType)),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function recalculateBondPreview(){var e=$("#ba-bond-levelrange").val(),t=getBondStats(student,e);$("#ba-student-bond-1-amount").text("+"+t[student.FavorStatType[0]]),$("#ba-student-bond-2-amount").text("+"+t[student.FavorStatType[1]])}function getBondStats(e,t){var a=0,i=0;for(let s=1;s<Math.min(t,50);s++)s<20?(a+=e.FavorStatValue[Math.floor(s/5)][0],i+=e.FavorStatValue[Math.floor(s/5)][1]):s<50&&(a+=e.FavorStatValue[2+Math.floor(s/10)][0],i+=e.FavorStatValue[2+Math.floor(s/10)][1]);return{[e.FavorStatType[0]]:a,[e.FavorStatType[1]]:i}}function getWeaponStats(e,t){let a={MaxHP:0,AttackPower:0,HealPower:0},i=(t-1)/99;return"Standard"==e.Weapon.StatLevelUpType&&(i=i.toFixed(4)),a.AttackPower=Math.round(e.Weapon.AttackPower1+(e.Weapon.AttackPower100-e.Weapon.AttackPower1)*i),a.MaxHP=Math.round(e.Weapon.MaxHP1+(e.Weapon.MaxHP100-e.Weapon.MaxHP1)*i),a.HealPower=Math.round(e.Weapon.HealPower1+(e.Weapon.HealPower100-e.Weapon.HealPower1)*i),a}function changeStatPreviewStars(e,t,a=!0){let i=stat_preview_weapon_stars;stat_preview_stars=e,stat_preview_weapon_stars=t;for(let t=1;t<=5;t++)$("#ba-statpreview-star-"+t).toggleClass("active",t<=e);for(let e=1;e<=3;e++)$("#ba-weaponpreview-star-"+e).toggleClass("active",e<=t);if(t>0){let e=20+10*t;$("#ba-statpreview-weapon-range").val(e),updateWeaponLevelStatPreview(e)}$("#ba-student-weapon-level").toggle(stat_preview_weapon_stars>0),(3==t&&i<3||3==i&&t<3)&&recalculateTerrainAffinity(),(t>=2&&i<2||i>=2&&t<2)&&updatePassiveSkillStatPreview(),a&&recalculateStatPreview()}function updatePassiveSkillStatPreview(){let e=stat_preview_weapon_stars>=2,t=find(student.Skills,"SkillType",(e?"weapon":"")+"passive")[0],a=getPassiveSkillBonus(t,$("#ba-statpreview-passiveskill-range").val());$("#ba-statpreview-passiveskill-name").text(getTranslatedString(t,"Name"));let i="";$(Object.entries(a)).each((function(e,t){let a=t[1];t[0].includes("_Coefficient")&&(a/=1e4),a>0&&(i+=`${getStatName(t[0])} <b>+${getFormattedStatAmount(a)}</b>, `)})),$("#ba-statpreview-passiveskill-desc").html(i.substring(0,i.length-2)),e?$("#ba-statpreview-passiveskill-icon-plus").show():$("#ba-statpreview-passiveskill-icon-plus").hide(),$("#ba-statpreview-status-passive-level .statpreview-label").text(`Lv.${$("#ba-statpreview-passiveskill-range").val()}`)}function updateSummonExSkillStatPreview(){if(student.SummonIds.length>0){$("#ba-statpreview-summon-level").show();let e=find(student.Skills,"SkillType","ex")[0],t=find(data.summons,"Id",student.SummonIds[0])[0],a=$("#ba-statpreview-exskill-range").val();$("#ba-statpreview-exskill-name").text(getTranslatedString(e,"Name")),$("#ba-statpreview-exskill-desc").empty();for(let i=0;i<e.SummonStat.length;i++)$("#ba-statpreview-exskill-desc").append((0==i?"":"\n")+getLocalizedString("ui","summon_ex_bonus",[getTranslatedString(t,"Name"),getStatName(e.SummonStat[i]),parseFloat((e.SummonStatCoefficient[i][a-1]/100).toPrecision(3)),getTranslatedString(student,"Name")]))}else $("#ba-statpreview-summon-level").hide()}function populateItemList(){itemsHtml={materials:"",gifts:"",eleph:"",furniture:"",equipment:"",currency:""},$.each(data.items,(function(e,t){if(t.IsReleased[regionID]){let e=getItemCardHTML(t,t.Id,"items");switch(t.Category){case"CharacterExpGrowth":case"Material":itemsHtml.materials+=e;break;case"Favor":itemsHtml.gifts+=e;break;case"SecretStone":itemsHtml.eleph+=e;break;case"Coin":itemsHtml.currency+=e}}})),$.each(data.furniture,(function(e,t){t.IsReleased[regionID]&&(itemsHtml.furniture+=getItemCardHTML(t,t.Id+1e6,"furniture"))})),$.each(data.equipment,(function(e,t){t.IsReleased[regionID]&&(itemsHtml.equipment+=getItemCardHTML(t,t.Id+2e6,"equipment"))})),Object.entries(itemsHtml).forEach(e=>$(`#ba-item-list-${e[0]}-grid`).html(e[1])),$(".ba-select-grid-item").tooltip({html:!0,delay:{show:200,hide:0},container:$(".tab-content")})}function populateCraftList(){html=[],html[0]="",html[1]="",html_h1=`<div id="stages-list-events-grid-header-1" class="w-100 ba-grid-header mb-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","1")}</h3></div>`,html_h2=`<div id="stages-list-events-grid-header-2" class="w-100 ba-grid-header my-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","2")}</h3></div>`,data.crafting.Nodes.sort((e,t)=>e.Quality-t.Quality),data.crafting.Nodes.sort((e,t)=>t.Icon.localeCompare(e.Icon)),$.each(data.crafting.Nodes,(function(e,t){t.IsReleased[regionID]&&t.Weight>0&&(html[t.Tier-1]+=getCraftingCardHTML(t))})),$("#ba-craft-list-nodes-grid").html(html_h1+html[0]+html_h2+html[1])}function getCraftingCardHTML(e){let t;return`<div class="ba-craft-node ba-student-info ba-panel ba-node-quality-${e.Quality}" onclick="loadCraft(${e.Id})"><img class="ba-craft-node-img" src="images/ui/${e.Icon}.png"><span style="margin-left:20px">${getTranslatedString(e,"Name")}</span></div>`}function populateStageList(){let e,t;e="",$.each(data.stages.Campaign,(function(t,a){a.Area<=data.common.regions[regionID].campaign_max&&(e+=getStageCardHTML(a))})),$("#ba-stages-list-missions-grid").html(e),e="",t="";let a="";$.each(data.stages.WeekDungeon,(function(i,s){if(s.Type!=a){let a=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`;s.Id<31e3?e+=a:t+=a}s.Id<31e3?s.Stage<=data.common.regions[regionID].bounty_max&&(e+=getStageCardHTML(s)):s.Stage<=data.common.regions[regionID].commission_max&&(t+=getStageCardHTML(s)),s.Area<=data.common.regions[regionID].commission_max&&(e+=getStageCardHTML(s)),a=s.Type})),$("#ba-stages-list-bounty-grid").html(e),$("#ba-stages-list-commissions-grid").html(t),e="",$.each(data.stages.SchoolDungeon,(function(t,i){i.Type!=a&&(e+=`<div id="stages-list-grid-header-${i.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+i.Type)}</h3></div>`),i.Stage<=data.common.regions[regionID].schooldungeon_max&&(e+=getStageCardHTML(i)),a=i.Type})),$("#ba-stages-list-schooldungeon-grid").html(e),e="";let i=0;data.common.regions[regionID].events.forEach(t=>{e+=`<div id="stages-list-events-grid-header-${t}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("EventName",""+t)}</h3></div>`,$.each(find(data.stages.Event,"EventId",t),(function(t,a){701==a.EventId&&a.Stage>data.common.regions[regionID].event_701_max||(e+=getStageCardHTML(a),i=a.EventId)}))}),$("#ba-stages-list-events-grid").html(e)}function populateRaidList(){var e="",e;e="",$.each(data.raids.Raid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a))})),$("#ba-raid-list-raid-grid").html(e),e="",$.each(data.raids.TimeAttack,(function(t,a){a.IsReleased[regionID]&&(e+=getTimeAttackCardHTML(a))})),$("#ba-raid-list-timeattack-grid").html(e),e="",$.each(data.raids.WorldRaid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a))})),$("#ba-raid-list-worldraid-grid").html(e)}function getUsedByStudents(e,t){let a="",i="Used by the following students";if("equipment"==t)$.each(data.students,(function(t,i){i.IsReleased[regionID]&&(i.Equipment[0]!=e.Category&&i.Equipment[1]!=e.Category&&i.Equipment[2]!=e.Category||(a+=getStudentIconSmall(i)))}));else if("furniture"==t)i=getLocalizedString("ui","furniture_interaction_list"),$.each(data.students,(function(t,i){if(!i.IsReleased[regionID])return;let s=!1;for(let t=0;t<i.FurnitureInteraction.length;t++)e.Id==i.FurnitureInteraction[t]&&(s=!0);s&&(a+=getStudentIconSmall(i))}));else if("items"==t)if("Material"==e.Category)i="Used to improve the following students' skills",$.each(data.students,(function(t,i){if(!i.IsReleased[regionID])return;let s=!1;for(let t=0;t<i.SkillExMaterial.length;t++){for(let a=0;a<i.SkillExMaterial[t].length;a++)if(e.Id==i.SkillExMaterial[t][a]){s=!0;break}if(s)break}if(!s)for(let t=0;t<i.SkillMaterial.length;t++){for(let a=0;a<i.SkillMaterial[t].length;a++)if(e.Id==i.SkillMaterial[t][a]){s=!0;break}if(s)break}s&&(a+=getStudentIconSmall(i))}));else if("SecretStone"==e.Category){i="Used to rank up the following character";let t=find(data.students,"Id",e.Id)[0];a+=getStudentIconSmall(t)}return""!=a?($("#ba-item-usage").show(),`<div class="mb-2"><i>${i}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">`+a+"</div>"):""}function getEquipmentRecipe(e){let t="",a="Crafted using the following items";if("Recipe"in e){for(let a=0;a<e.Recipe.length;a++)t+=getDropIconHTML(e.Recipe[a][0]+2e6,e.Recipe[a][1]);t+=getDropIconHTML(3000001,e.RecipeCost)}return""!=t?($("#ba-equipment-recipe").show(),`<div class="mb-2"><i>${a}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">`+t+"</div>"):""}function getLikedByStudents(e){var t='<div class="mb-2"><i>Loved by the following students</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">',a='<div class="mb-2"><i>Liked by the following students</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">';return $.each(data.students,(function(i,s){if(!s.IsReleased[regionID])return;let n=s.FavorItemTags;n.push(s.FavorItemUniqueTags[0]);let r=getFavouriteItems(n),l=!1,o=!1;for(let t=0;t<r[0].length;t++)if(e.Id-5e3==r[0][t]){o=!0;break}for(let t=0;t<r[1].length;t++)if(e.Id-5e3==r[1][t]){l=!0;break}let d=getStudentIconSmall(s);l&&(a+=d),o&&(t+=d)})),a+="</div>",t+="</div>",$("#ba-item-usage").show(),t+a}function getItemDropStages(e){let t="",a=[];return $.each([data.stages.Campaign,data.stages.SchoolDungeon,data.stages.WeekDungeon],(function(t,i){$.each(i,(function(t,i){if(!stageIsReleased(i))return;let s=!1,n=0;if("Default"in i.Rewards)for(let t=0;t<i.Rewards.Default.length;t++)if(e==i.Rewards.Default[t][0]){s=!0,n=i.Rewards.Default[t][1];break}s&&a.push({chance:n,stage:i})}))})),a=a.sort((e,t)=>t.chance-e.chance),$.each(a,(function(e,a){t+='<div class="m-1">'+getStageCardHTML(a.stage,a.chance)+"</div>"})),""!=t?($("#ba-item-sources").show(),'<div class="mb-2"><i>Obtained from the following missions</i></div><div class="d-flex justify-content-center flex-wrap">'+t+"</div>"):""}function loadJSON(e,t){results={};var a=Object.entries(e).map((function(e){return $.getJSON(e[1],(function(t){results[e[0]]=t}))}));Promise.all(a).then((function(){t(results)}))}function find(e,t,a){var i=[];return $.each(e,(function(e,s){s[t]==a&&i.push(s)})),i}function findOrDefault(e,t,a,i){var s=[],n=[];return $.each(e,(function(e,r){r[t]==a&&s.push(r),r[t]==i&&n.push(r)})),0==s.length?n:s}function getAttackTypeText(e){switch(e){case"Normal":return getLocalizedString("ui","attack_type_normal_desc");case"Explosion":return getLocalizedString("ui","attack_type_desc",[`<b class='ba-col-explosion'>${getLocalizedString("ArmorType","LightArmor")}</b>`,`<b class='ba-col-mystic'>${getLocalizedString("ArmorType","Unarmed")}</b>`]);case"Pierce":return getLocalizedString("ui","attack_type_desc",[`<b class='ba-col-pierce'>${getLocalizedString("ArmorType","HeavyArmor")}</b>`,`<b class='ba-col-explosion'>${getLocalizedString("ArmorType","LightArmor")}</b>`]);case"Mystic":return getLocalizedString("ui","attack_type_desc",[`<b class='ba-col-mystic'>${getLocalizedString("ArmorType","Unarmed")}</b>`,`<b class='ba-col-pierce'>${getLocalizedString("ArmorType","HeavyArmor")}</b>`])}return text}function getDefenseTypeText(e){switch(e){case"Normal":return getLocalizedString("ui","defense_type_normal_desc");case"LightArmor":return getLocalizedString("ui","defense_type_desc",[`<b class='ba-col-explosion'>${getLocalizedString("BulletType","Explosion")}</b>`,`<b class='ba-col-pierce'>${getLocalizedString("BulletType","Pierce")}</b>`]);case"HeavyArmor":return getLocalizedString("ui","defense_type_desc",[`<b class='ba-col-pierce'>${getLocalizedString("BulletType","Pierce")}</b>`,`<b class='ba-col-mystic'>${getLocalizedString("BulletType","Mystic")}</b>`]);case"Unarmed":return getLocalizedString("ui","defense_type_desc",[`<b class='ba-col-mystic'>${getLocalizedString("BulletType","Mystic")}</b>`,`<b class='ba-col-explosion'>${getLocalizedString("BulletType","Explosion")}</b>`])}return text}function getSkillText(e,t,a,i){var s=e,n=1,r;for(r=/[0-9.]+[%s秒]/g,s=s.replace(r,(function(e){return`<strong>${e}</strong>`}));s.includes("<?"+n+">");)s="raid"==i?1==a&&t[n-1][a-1]!=t[n-1][a]||a>1&&t[n-1][a-1]!=t[n-1][a-2]?s.replace("<?"+n+">",`<span class="ba-col-emphasis">${t[n-1][a-1]}</span>`):s.replace("<?"+n+">",t[n-1][a-1].replace(r,(function(e){return`<strong>${e}</strong>`}))):s.replace("<?"+n+">",'<span class="ba-col-'+i.toLowerCase()+'">'+t[n-1][a-1]+"</span>"),n+=1;return r=/<d:(\w+)>/g,s=s.replace(r,(function(e,t){return`<span class="ba-skill-debuff" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/buff/Combat_Icon_Debuff_${t}.png`,data.common.buffs["Debuff_"+t].tooltip_title,"Debuff",null,data.common.buffs["Debuff_"+t].tooltip_body,30)}"><img class="ba-buff-icon" src="images/buff/Combat_Icon_Debuff_${t}.png"><span class="ba-buff-icon-spacer"></span>${getTranslatedString(data.common.buffs["Debuff_"+t],"Name")}</span>`})),r=/<b:(\w+)>/g,s=s.replace(r,(function(e,t){return`<span class="ba-skill-buff" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/buff/Combat_Icon_Buff_${t}.png`,data.common.buffs["Buff_"+t].tooltip_title,"Buff",null,data.common.buffs["Buff_"+t].tooltip_body,30)}"><img class="ba-buff-icon" src="images/buff/Combat_Icon_Buff_${t}.png"><span class="ba-buff-icon-spacer"></span>${getTranslatedString(data.common.buffs["Buff_"+t],"Name")}</span>`})),r=/<c:(\w+)>/g,s=s.replace(r,(function(e,t){return`<span class="ba-skill-cc" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/buff/Combat_Icon_CC_${t}.png`,data.common.buffs["CC_"+t].tooltip_title,"CC Effect",null,data.common.buffs["CC_"+t].tooltip_body,30)}"><img class="ba-buff-icon" src="images/buff/Combat_Icon_CC_${t}.png"><span class="ba-buff-icon-spacer"></span>${getTranslatedString(data.common.buffs["CC_"+t],"Name")}</span>`})),r=/<s:(\w+)>/g,s=s.replace(r,(function(e,t){return`<span class="ba-skill-special" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/buff/Combat_Icon_Special_${t}.png`,data.common.buffs["Special_"+t].tooltip_title,"Status",null,data.common.buffs["Special_"+t].tooltip_body,30)}"><img class="ba-buff-icon" src="images/buff/Combat_Icon_Special_${t}.png"><span class="ba-buff-icon-spacer"></span>${getTranslatedString(data.common.buffs["Special_"+t],"Name")}</span>`}))}function getRichTooltip(e,t,a,i,s,n=50,r=""){var l="<span class='ba-tooltip'>";return l+="<div class='ba-tooltip-header'>",null!=e&&(l+=`<div class='ba-tooltip-img'><img class='${r}' src='${e}' width='${n}' height='${n}'></div>`),l+=`<div class='flex-fill d-flex flex-column'><div class='flex-fill d-flex flex-column justify-content-center'><div class='ba-tooltip-title'>${t.replace("-","&#8209;")}</div></div>`,null==a&&null==i||(l+="<div class='d-flex align-items-center mt-auto'>",l+=null!=a?`<span class='ba-tooltip-subtitle flex-fill'>${a}</span>`:"",l+=null!=i?`<span class='ba-tooltip-rarity text-bold'>${i}</span>`:"",l+="</div>"),l+="</div></div>",null!=s&&""!=s&&(l+=`<div class='ba-tooltip-body'>${s.replace(/\"/g,"&quot;")}</div>`),l+="</span>"}function getBasicTooltip(e){var t="<span class='ba-tooltip'>";return t+="<div class='ba-tooltip-header m-0'>",t+=`<div class='d-flex justify-content-center w-100'><div class='ba-tooltip-title text-center fs-6'>${e}</div></div>`,t+="</div>",t+="</span>"}function abbreviateNumber(e){for(var t=e,a=0,i=["","K","M","B"];t>=1e3;)a++,t/=1e3;return t+i[a]}function toggleDarkTheme(e){darkTheme=e,$("#ba-navbar-themeswitcher button").removeClass("active"),$(`#ba-navbar-themeswitcher-${e}`).addClass("active"),localStorage.setItem("theme",e),"auto"==e?$("body").toggleClass("theme-dark",window.matchMedia("(prefers-color-scheme: dark)").matches):$("body").toggleClass("theme-dark","dark"==e),document.querySelector('meta[name="theme-color"]').setAttribute("content",$("body").hasClass("theme-dark")?"#212529":"#dee2e6")}function toggleHighContrast(e){highContrast=e,$("#ba-navbar-contrast-toggle button").removeClass("active"),$(`#ba-navbar-contrast-toggle-${highContrast}`).addClass("active"),localStorage.setItem("high_contrast",highContrast),$("body").toggleClass("high-contrast",highContrast)}function changeRegion(e){regionID=e,localStorage.setItem("region",regionID),location.reload()}function changeLanguage(e){userLang=e,localStorage.setItem("language",e),location.reload()}function loadLanguage(e){$("*[data-localize-id]").each((function(e,t){let a=$(t).data("localize-id").split(",")[0],i=$(t).data("localize-id").split(",")[1];$(t).html(getLocalizedString(a,i))})),$("#ba-student-search-text").attr("placeholder",getLocalizedString("ui","student_search_textbox_placeholder"))}function getRarityStars(e){switch(e){case"N":case"R":case 1:return"<i class='fa-solid fa-star'></i>".repeat(1);case"SR":case 2:return"<i class='fa-solid fa-star'></i>".repeat(2);case"SSR":case 3:return"<i class='fa-solid fa-star'></i>".repeat(3)}}function getRarityTier(e){switch(e){case"N":return"<i class='fa-solid fa-star'></i>".repeat(1);case"R":return"<i class='fa-solid fa-star'></i>".repeat(2);case"SR":return"<i class='fa-solid fa-star'></i>".repeat(3);case"SSR":return"<i class='fa-solid fa-star'></i>".repeat(4)}}function searchContains(e,t){if("En"!=userLang){if(t.includes(e))return!0}else{let a=t.toLowerCase().replace(/[^a-z0-9\- ]/g,""),i=e.toLowerCase().replace(/[^a-z0-9\- ]/g,"");if(a.startsWith(i))return!0;for(;a.includes(" ");)if(a=a.substring(a.indexOf(" ")+1),a.startsWith(i))return!0}return!1}function allSearch(){let e=$("#ba-navbar-search").val().toLowerCase();if(""==e)return $("#navbar-search-results").html("").hide(),$("#ba-navbar-search").removeClass("has-text results-open"),$("#navbar-search-clear").hide(),searchResultsCount=0,searchResultsSelection=0,!0;$("#navbar-search-clear").show(),$("#ba-navbar-search").addClass("has-text"),$("#navbar-search-results").html("").show();let t=[],a=6;if($.each(data.students,(function(a,i){if(i.IsReleased[regionID]&&searchContains(e,getTranslatedString(i,"Name"))&&(t.push({name:getTranslatedString(i,"Name"),icon:"images/student/collection/"+i.CollectionTexture+".webp",type:"Student",rarity:"",rarity_text:getRarityStars(i.StarGrade),onclick:`loadStudent('${i.DevName}')`}),t.length>=6))return!1})),t.length<6&&$.each(data.raids.Raid,(function(a,i){if(i.IsReleased[regionID]&&searchContains(e,getTranslatedString(i,"Name"))&&(t.push({name:getTranslatedString(i,"Name"),icon:"images/raid/"+i.Icon+".png",type:"Total Assault Boss",rarity:"",rarity_text:"",onclick:`loadRaid(${i.Id})`}),t.length>=6))return!1})),t.length<6&&$.each(data.items,(function(a,i){if(i.IsReleased[regionID]&&searchContains(e,getTranslatedString(i,"Name"))&&(t.push({name:getTranslatedString(i,"Name"),icon:"images/items/"+i.Icon+".png",type:getLocalizedString("ItemCategory",i.Category),rarity:i.Rarity,rarity_text:getRarityStars(i.Rarity),onclick:`loadItem(${i.Id})`}),t.length>=6))return!1})),t.length<6&&$.each(data.furniture,(function(a,i){if(i.IsReleased[regionID]&&searchContains(e,getTranslatedString(i,"Name"))&&(t.push({name:getTranslatedString(i,"Name"),icon:"images/furniture/"+i.Icon+".png",type:getLocalizedString("ItemCategory",i.Category),rarity:i.Rarity,rarity_text:getRarityStars(i.Rarity),onclick:`loadItem(${i.Id+1e6})`}),t.length>=6))return!1})),t.length<6&&$.each(data.equipment,(function(a,i){if(i.IsReleased[regionID]&&searchContains(e,getTranslatedString(i,"Name"))&&(t.push({name:getTranslatedString(i,"Name"),icon:"images/equipment/"+i.Icon+".png",type:getLocalizedString("ItemCategory",i.Category),rarity:i.Rarity,rarity_text:getRarityStars(i.Rarity),onclick:`loadItem(${i.Id+2e6})`}),t.length>=6))return!1})),t.length<6&&$.each(data.stages.Campaign,(function(a,i){let s=i.Area+"-"+i.Stage+" "+(1==i.Difficulty?"Hard":"Normal");if(i.Area<=data.common.regions[regionID].campaign_max&&searchContains(e,s)&&(t.push({name:s,icon:"images/campaign/"+getStageIcon(i,"Campaign")+".png",type:"Stage",rarity:"",rarity_text:"",onclick:`loadStage('${i.Id}')`}),t.length>=6))return!1})),t.length<6&&$.each(data.stages.WeekDungeon,(function(a,i){let s=getStageTitle(i,"WeekDungeon");if(stageIsReleased(i)&&searchContains(e,s)&&(t.push({name:s,icon:"images/campaign/"+getStageIcon(i,"WeekDungeon")+".png",type:"Stage",rarity:"",rarity_text:"",onclick:`loadStage('${i.Id}')`}),t.length>=6))return!1})),t.length<6&&$.each(data.stages.SchoolDungeon,(function(a,i){let s=getStageTitle(i,"SchoolDungeon");if(stageIsReleased(i)&&searchContains(e,s)&&(t.push({name:s,icon:"images/campaign/"+getStageIcon(i,"SchoolDungeon")+".png",type:"Stage",rarity:"",rarity_text:"",onclick:`loadStage('${i.Id}')`}),t.length>=6))return!1})),t.length>0){var i="";for(let e=0;e<t.length;e++)i+=`<div id="ba-search-result-item-${e+1}" class="ba-search-result-item" onclick="${t[e].onclick}; $('#navbar-search-clear').trigger('onclick');">\n            <div class='ba-search-img'><img src='${t[e].icon}' class='ba-item-${t[e].rarity.toLowerCase()}' width=50 height=50></div>\n            <div class='flex-fill d-flex flex-column'><div class='flex-fill d-flex flex-column justify-content-end'><div class='ba-search-name'>${t[e].name}</div></div>\n            <div class='d-flex align-items-center mt-auto'>\n            <span class='ba-search-subtitle flex-fill'>${t[e].type}</span>\n            <span class='ba-search-rarity'>${t[e].rarity_text}</span></div></div></div>`;$("#navbar-search-results").html(i),$("#ba-navbar-search").addClass("results-open"),searchResultsCount=t.length,searchResultsSelection=0}else $("#navbar-search-results").hide(),$("#ba-navbar-search").removeClass("results-open"),searchResultsCount=0,searchResultsSelection=0}function searchNavigate(e){13==e.keyCode&&(e.preventDefault(),"keyup"==e.type&&$("#ba-search-result-item-"+searchResultsSelection).trigger("onclick")),40==e.keyCode?(e.preventDefault(),"keydown"==e.type&&searchResultsSelection<searchResultsCount&&(searchResultsSelection++,$(".ba-search-result-item").removeClass("selected"),$("#ba-search-result-item-"+searchResultsSelection).addClass("selected"))):38==e.keyCode&&(e.preventDefault(),"keydown"==e.type&&searchResultsSelection>1&&(searchResultsSelection--,$(".ba-search-result-item").removeClass("selected"),$("#ba-search-result-item-"+searchResultsSelection).addClass("selected")))}function clearSearchBar(e){let t;$("#"+e.dataset.target).val("").blur().trigger("oninput"),$(e).hide()}function getLocalizedString(e,t,a=[]){return data.localization.strings.hasOwnProperty(e)&&data.localization.strings[e].hasOwnProperty(t)?data.localization.strings[e][t].hasOwnProperty(userLang)?formatString(data.localization.strings[e][t][userLang],a):(console.log(`Localization not defined for "${e}, ${t}" for locale "${userLang}"`),formatString(data.localization.strings[e][t].En,a)):(console.log(`Localization not defined for "${e}, ${t}"`),"undefined!!!")}function getTranslatedString(e,t){return e[t]?e[t]:e[t+userLang]?e[t+userLang]:e[t+"Jp"]?e[t+"Jp"]:e[t+"En"]?e[t+"En"]:(console.log(`No translations defined for "${e}.${t}"`),"")}function getFavouriteItems(e){let t=[],a=[];for(let i=0;i<35;i++){let s=find(data.items,"Id",5e3+i)[0].Tags.filter(t=>e.includes(t));1==s.length?t.push(i):s.length>1&&a.push(i)}return[a,t]}function getCacheVerResourceName(e){return e+"?v=8"}function getTimeAttackLevelScale(e){return e<=1?0:2==e?.0101:e<=24?.0707:25==e?.0808:e<=39?.1919:40==e?.202:e<=64?.4444:65==e?.4545:e<=77?.7172:78==e?.7273:e>=79?((e-1)/99).toFixed(4):void 0}function getPassiveSkillBonus(e,t){let a={};return e.Parameters.forEach((i,s)=>{i[t-1].includes("%")?a[e.Stat[s]+"_Coefficient"]=Math.round(100*parseFloat(i[t-1].replace("%",""))):a[e.Stat[s]+"_Base"]=Math.round(i[t-1])}),a}function stageIsReleased(e){return e.Id>8e6?e.EventId in data.common.regions[regionID].events:e.Id>1e6?e.Area<=data.common.regions[regionID].campaign_max:e.Id>6e4?e.Stage<=data.common.regions[regionID].schooldungeon_max:e.Id>31e3?e.Stage<=data.common.regions[regionID].commission_max:e.Id>3e4&&e.Stage<=data.common.regions[regionID].bounty_max}function updateStatPreviewTitle(){if(statPreviewSummonStats){let e=find(data.summons,"Id",student.SummonIds[0])[0];$("#ba-statpreview-status-title").text(getTranslatedString(e,"Name")),$("#ba-statpreview-status-title-icon").attr("src",`images/skill/${student.Skills[0].Icon}.png`).addClass(`bg-skill-${student.BulletType.toLowerCase()}`)}else $("#ba-statpreview-status-title").html(getTranslatedString(student,"PersonalName")),$("#ba-statpreview-status-title-icon").attr("src",`images/student/icon/${student.CollectionTexture}.png`).removeClass("bg-skill-explosion bg-skill-pierce bg-skill-mystic");compareMode&&($("#ba-statpreview-status-title-compare").html(getTranslatedString(studentCompare,"PersonalName")),$("#ba-statpreview-status-title, #ba-statpreview-status-title-compare"),$("#ba-statpreview-status-title-compare-icon").attr("src",`images/student/icon/${studentCompare.CollectionTexture}.png`).removeClass("bg-skill-explosion bg-skill-pierce bg-skill-mystic")),$(".statpreview-compare").toggle(compareMode),compareMode?$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip("Remove Comparison"),placement:"top",html:!0}):$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip("Compare with Student"),placement:"top",html:!0})}function openStudentComparison(){compareMode?(compareMode=!1,recalculateStatPreview(),updateStatPreviewTitle()):($(`#ba-student-select-${student.Id}>div`).addClass("disabled"),selectCompareMode=!0,studentSelectorModal.show())}function drawHexamap(e){$("#ba-stage-map-canvas").empty();const t=90;let a=99,i=99,s=-99,n=-99,r=999999,l=0,o=50;e.HexaMap.forEach(e=>{a=Math.min(a,e.Pos[0]),i=Math.min(i,e.Pos[1]),n=Math.max(n,e.Pos[0]),s=Math.max(s,e.Pos[1])}),e.HexaMap.forEach(e=>{let t=e.Pos[0]-a,s=e.Pos[1]-i;r=Math.min(r,90*t+90*s*.5),l=Math.max(l,90+90*t+90*s*.5)}),console.log(`x_min ${a}, y_min ${i}`);let d=new Array(e.HexaMap.length).fill(0),c=0;e.HexaMap.forEach((t,n)=>{let o=t.Pos[0]-a,g=t.Pos[1]-i;const u=90*o+90*g*.5-r,m=g*Math.sqrt(3*Math.pow(45,2))+50,p=[102101,902101,903108];let b="",h="";if(t.Type.startsWith("TileRemoveObject_TargetTile")&&0==d[n]&&0==d[t.Trigger]&&(c++,d[n]=c,d[t.Trigger]=c),"Entity"in t)if(t.Entity>1e8){let a=find(e.Formations,"Id",t.Entity)[0],i;if(b+=`<img class="ba-stage-map-enemy" src="images/enemy/${a.MapIcon}.png" style="z-index:${g}">`,b+='<div class="map-info">',h=` onclick="populateMapEnemyList(${t.Entity});" `,"Guard"==a.MoveType?b+='<span class="move-type guard"><i class="fa-solid fa-triangle-exclamation"></i></span>':"Pursuit"==a.MoveType&&(b+='<span class="move-type pursuit"><i class="fa-solid fa-angles-left"></i></span>'),b+=`<span class="def-type bg-def-${find(data.enemies,"Id",a.EnemyList[0])[0].ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="height:100%;"></span>`,b+="</div>","Grade"==a.UnitGrade.slice(0,5)){let e;b+=`<span class="unit-grade"><span class="grade">RANK<img src="images/ui/Strategy_Icon_EnemyRank_${parseInt(a.UnitGrade.slice(-1))}.png"></span></span>`}else"Boss"==a.UnitGrade&&(b+='<span class="unit-grade boss"></span>')}else if(t.Entity>1e6){let e=find(data.items,"Id",9e4)[0];b+=`<span class="tile-item" style="z-index:${g}" title="${getRichTooltip(`images/items/${e.Icon}.png`,getTranslatedString(e,"Name"),getLocalizedString("ItemCategory",e.Category),getRarityStars(e.Rarity),getTranslatedString(e,"Desc"),50,"img-scale-larger")}"><i class="fa-solid fa-gift"></i></span>`}else switch(t.Entity){case 101101:b+='<span class="start-tile"></span>';break;case 102101:case 902101:case 903108:b+=`<span class="tile-icon" style="z-index:${g}" title="${getBasicTooltip("Spawn Tile")}"><i class="fa-solid fa-shoe-prints" style="transform:rotate(315deg);"></i></span>`;break;case 103101:case 103102:b+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip("Drone (Reveals surrounding tiles)")}"><i class="fa-solid fa-eye"></i></span>`;break;case 102201:case 903101:b+=`<span class="tile-icon" style="z-index:${g}" title="${getBasicTooltip("Remove Tile")}"><i class="fa-solid fa-shoe-prints" style="transform:rotate(315deg);font-size: 20px;"></i><i class="fa-solid fa-ban" style="position: absolute;font-size: 38px;"></i></span>`;break;case 104101:case 104102:b+=`<span class="tile-icon group-${t.Entity-104100}" style="z-index:${g}" title="${getBasicTooltip("Two-way Teleporter")}"><i class="fa-solid fa-up-long"></i><i class="fa-solid fa-down-long"></i></span>`;break;case 105101:case 105201:b+=`<span class="tile-icon group-${(t.Entity-105001)/100+2}" style="z-index:${g}" title="${getBasicTooltip("One-way Teleporter Entrance")}"><i class="fa-solid fa-up-long"></i></span>`;break;case 105102:case 105202:b+=`<span class="tile-icon group-${(t.Entity-105002)/100+2}" style="z-index:${g}" title="${getBasicTooltip("One-way Teleporter Exit")}"><i class="fa-solid fa-down-long"></i></span>`;break;case 106101:b+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip("Food Pickup\n(Heals unit for 50% of their Max HP)")}"><i class="fa-solid fa-bowl-rice"></i></span>`;break;case 107101:b+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip("Gun Pickup\n(Increases unit's attack by 10% for the next two turns)")}"><i class="fa-solid fa-gun"></i></span>`;break;case 107201:b+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip("Armor Pickup\n(Increases unit's defense by 10% for the next two turns)")}"><i class="fa-solid fa-shield"></i></span>`;break;case 109201:case 109202:case 109203:b+=`<span class="tile-icon lowered group-${t.Entity-109200}" style="z-index:${g}" title="${getBasicTooltip("Lowered Switch Tile")}"><i class="fa-solid fa-chevron-up" style="margin-top: 12px;"></i></span>`;break;case 109204:case 109205:case 109206:b+=`<span class="tile-icon raised group-${t.Entity-109200-3}" style="z-index:${g}" title="${getBasicTooltip("Raised Switch Tile")}"><i class="fa-solid fa-chevron-down"></i></span>`;break;case 109301:case 109302:case 109303:b+=`<span class="tile-icon switch-tile lowered group-${t.Entity-109300}" style="z-index:${g}" title="${getBasicTooltip("Lowered Tile")}"></span>`;break;case 109304:case 109305:case 109306:b+=`<span class="tile-icon switch-tile group-${t.Entity-109300-3}" style="z-index:${g}" title="${getBasicTooltip("Raised Tile")}"></span>`}b=`<div class="ba-stage-map-tile map-tile-${n} ${t.Type.startsWith("TileRemoveObject_TargetTile")&&p.includes(e.HexaMap[t.Trigger].Entity)?"hidden-tile":""} ${t.Type.startsWith("DisposableTileObject")?"cracked-tile":""}" ${h} style="left:${u}px;top:${m.toFixed(0)}px;${""!=h?"cursor:pointer;":""}">${b}</div>`,$("#ba-stage-map-canvas").css("width",`${l-r}px`),$("#ba-stage-map-canvas").css("height",`${150+(s-i)*Math.sqrt(3*Math.pow(45,2))}px`),$("#ba-stage-map-canvas").append(b),$(".tile-icon, .tile-item").tooltip({html:!0})}),d.forEach((e,t)=>{$(`.map-tile-${t}`).addClass(`group-${e}`)})}function makeDraggable(e){$(e).on("mousedown",t=>{$(e).toggleClass("scrolling",!0),scrolling=!0,scrollPosition={left:e.scrollLeft(),top:e.scrollTop(),x:t.clientX,y:t.clientY}}),$(e).on("mouseleave",t=>{scrolling=!1,$(e).toggleClass("scrolling",!1)}),$(e).on("mouseup",t=>{scrolling=!1,$(e).toggleClass("scrolling",!1)}),$(e).on("mousemove",t=>{t.preventDefault(),scrolling&&($(e).scrollLeft(scrollPosition.left-(t.clientX-scrollPosition.x)),$(e).scrollTop(scrollPosition.top-(t.clientY-scrollPosition.y)))})}loadJSON(json_list,(function(e){data=e,$.holdReady(!1)})),localStorage.getItem("theme")&&$("body").toggleClass("theme-dark","dark"==localStorage.getItem("theme")),$(document).ready((function(){localStorage.getItem("region")?loadRegion(localStorage.getItem("region")):loadRegion(0),data.students.sort(sort_functions.Name),studentList=data.students.map(e=>e),darkTheme=localStorage.getItem("theme")?localStorage.getItem("theme"):"auto",toggleDarkTheme(darkTheme),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{"auto"==darkTheme&&($("body").toggleClass("theme-dark",e.matches),document.querySelector('meta[name="theme-color"]').setAttribute("content",$("body").hasClass("theme-dark")?"#212529":"#dee2e6"))}),$("body").toggleClass("reduced-motion",!1),highContrast=localStorage.getItem("high_contrast")?"true"==localStorage.getItem("high_contrast"):!CSS.supports("backdrop-filter","blur(1px)")||window.matchMedia("(prefers-contrast: more)").matches,$("body").toggleClass("high-contrast",highContrast),$(`#ba-navbar-regionselector-${regionID}`).addClass("active"),$("#ba-navbar-languageselector span").text($(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).text()),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).addClass("active"),$(`#ba-navbar-themeswitcher-${darkTheme}`).addClass("active"),$(`#ba-navbar-contrast-toggle-${highContrast}`).addClass("active"),$(window).on("popstate",loadModuleFromURL),loadModuleFromURL()}));